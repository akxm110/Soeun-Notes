<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ë©”ëª¨ í¬ì¸íŠ¸ ì•±</title>
    <!-- Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com?v=2"></script>
    <style>
        /* ì–´ë¦°ì´ìš© ê·€ì—¬ìš´ í°íŠ¸ */
        @import url('https://fonts.googleapis.com/css2?family=Gamja+Flower&family=Nanum+Pen+Script&display=swap');
        
        body {
            font-family: "Gamja Flower", cursive;
			background: #eff2ff;
            background-attachment: fixed;
        }
        
        /* í° í…ìŠ¤íŠ¸ */
        h1, h2, h3 {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        /* "ì˜í–ˆì–´ìš”!" ë©”ì‹œì§€ íŠ¸ëœì§€ì…˜ */
        #toast-message {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            font-size: 1.5rem;
            animation: bounce 0.5s ease-in-out;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* textarea í¬ì»¤ìŠ¤ ì‹œ ê·¸ë¦¼ì ê°•ì¡° */
        textarea:focus-within {
            box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.5);
        }
        
        /* ëª¨ë‹¬ íŠ¸ëœì§€ì…˜ */
        #memo-modal {
            transition: opacity 0.3s ease-in-out;
        }
        #modal-content {
            transition: transform 0.3s ease-in-out;
            border: 4px solid #ffd700;
        }
        
        /* ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ */
        button:hover {
            transform: scale(1.05);
            transition: transform 0.2s;
        }
        
        /* ì¹´ë“œ íš¨ê³¼ */
        .category-card {
            border: 3px solid #fff;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        
        /* ê·€ì—¬ìš´ ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
        
        .achievement-emoji {
            animation: wiggle 0.5s ease-in-out infinite;
        }
    </style>
</head>
<body class="min-h-screen text-gray-800">

    <!-- ì „ì²´ ë˜í¼ -->
    <div class="container mx-auto max-w-7xl p-4">

        <!-- í—¤ë”: íƒ€ì´í‹€ ë° í¬ì¸íŠ¸ (í•­ìƒ ë³´ì„) -->
		<header id="app-header" class="flex justify-between items-center mb-8 p-6 rounded-3xl shadow-lg transition-colors duration-500" style="background: #b9c3ff;">
			<div class="flex-1"></div>
			<div class="flex items-center justify-center">
				<img src="./soeun-header.png" alt="header image" class="h-20 w-20 object-cover rounded-full shadow"/>
			</div>
			<div class="flex-1 flex justify-end items-center gap-4">
				<button id="point-history-btn" class="hidden md:block bg-white bg-opacity-90 hover:bg-opacity-100 text-purple-600 font-bold py-3 px-6 rounded-full transition duration-300 text-lg shadow-lg">â­ í¬ì¸íŠ¸ ë‚´ì—­</button>
				<div class="text-right cursor-pointer bg-white bg-opacity-90 p-4 rounded-2xl shadow-lg" id="points-box">
					<span class="text-sm text-purple-600 font-bold">ğŸ† ì´ í¬ì¸íŠ¸</span>
					<p id="points-display" class="text-3xl font-bold text-purple-600">0 P</p>
				</div>
			</div>
		</header>

        <!-- í™ˆ í˜ì´ì§€: ì¹´í…Œê³ ë¦¬ ëŒ€ì‹œë³´ë“œ -->
        <main id="home-page">
            <!-- ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€ í¼ -->
			<form id="category-form" class="bg-white p-6 rounded-3xl shadow-lg mb-8 flex space-x-3 border-2" style="border-color:#d9dfff;">
                <input type="text" id="category-name-input" placeholder="âœï¸ ìƒˆë¡œìš´ ì£¼ì œë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!" class="w-full px-5 py-3 border-3 border-purple-300 rounded-2xl focus:ring-4 focus:ring-yellow-300 transition duration-200 text-lg">
				<button type="submit" class="text-white font-extrabold py-3 px-6 rounded-2xl transition duration-300 shadow-lg whitespace-nowrap text-lg" style="background-color:#34d48a;">
					â• ì¶”ê°€í•˜ê¸°
				</button>
            </form>

            <!-- ì¹´í…Œê³ ë¦¬ ëª©ë¡ í—¤ë” ë° ì„ íƒ ëª¨ë“œ -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">ğŸ“š ë‚´ ì£¼ì œ ëª©ë¡</h2>
				<button id="multi-view-btn" class="bg-white text-gray-900 font-bold py-3 px-6 rounded-full border transition duration-200 shadow text-lg" style="border-color:#d9dfff;">
                    ğŸ¯ ì—¬ëŸ¬ê°œ ë³´ê¸°
                </button>
            </div>
            
            <!-- ì¹´í…Œê³ ë¦¬ ëª©ë¡ -->
            <div id="category-list" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
        </main>

        <!-- ìƒì„¸ í˜ì´ì§€: ë‹¨ì¼ ì¹´í…Œê³ ë¦¬ ë©”ëª¨ ëª©ë¡ -->
        <main id="detail-page" class="hidden">
            <button id="back-to-home" class="mb-6 bg-white text-gray-900 font-bold py-3 px-6 rounded-full shadow transition duration-200 text-lg border" style="border-color:#d9dfff;">
                ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>

			<form id="memo-form" class="bg-white p-6 rounded-3xl shadow-lg mb-8 border-2" style="border-color:#d9dfff;">
				<textarea id="memo-content" rows="3" placeholder="ì—¬ê¸°ì— ë©”ëª¨ë¥¼ ì…ë ¥..." class="w-full px-5 py-3 border-2 rounded-2xl focus:ring-4 transition duration-200 resize-none text-lg" style="border-color:#d9dfff;"></textarea>
				<button type="submit" class="w-full mt-4 text-white font-extrabold py-4 px-6 rounded-2xl transition duration-300 shadow-lg flex items-center justify-center text-lg" style="background-color:#34d48a;">
					<svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
						<rect x="5" y="3" width="14" height="18" rx="2" fill="white" fill-opacity="0.2"/>
						<path d="M8 7h8M8 11h8M8 15h5" stroke="white" stroke-width="1.8" stroke-linecap="round"/>
					</svg>
					ê¾¹! ì €ì¥í•˜ê¸°
				</button>
			</form>

            <h3 class="text-3xl font-bold mb-6 text-blue-600">ğŸ“ í•  ì¼ ëª©ë¡</h3>
            <div id="memo-list-pending" class="grid grid-cols-1 gap-4"></div>
        </main>

        <!-- í¬ì¸íŠ¸ ë‚´ì—­ í˜ì´ì§€ -->
        <main id="point-history-page" class="hidden">
            <button id="back-to-home-points" class="mb-6 bg-white text-gray-900 font-bold py-3 px-6 rounded-full shadow transition duration-200 text-lg border" style="border-color:#d9dfff;">
                ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
            </button>
            
            <h2 class="text-4xl font-bold mb-6 text-purple-600">â­ í¬ì¸íŠ¸ ë‚´ì—­</h2>
            
            <div class="rounded-3xl shadow p-8 mb-8 border" style="background:#fff;border-color:#d9dfff;">
                <div class="text-center">
                    <p class="text-gray-700 text-xl mb-3 font-bold">ğŸ† ëª¨ì€ í¬ì¸íŠ¸</p>
                    <p id="total-points-display" class="text-6xl font-extrabold text-purple-600 mb-6">0 P</p>
                    <button id="reset-points-btn" class="bg-white text-gray-900 font-bold py-3 px-8 rounded-full transition duration-200 shadow border text-lg" style="border-color:#d9dfff;">
                        ğŸ”„ í¬ì¸íŠ¸ ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
            
            <div id="point-history-list" class="space-y-4"></div>
        </main>

        <!-- ë©€í‹°ë·° í˜ì´ì§€: ì—¬ëŸ¬ ì¹´í…Œê³ ë¦¬ ë™ì‹œì— ë³´ê¸° -->
        <main id="multi-view-page" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <button id="back-to-home-multi" class="bg-gradient-to-r from-orange-400 to-red-400 text-white hover:from-orange-500 hover:to-red-500 font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 text-lg">
                    ğŸ  í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
                <!-- ì—´ ê°œìˆ˜ ì„ íƒ -->
                <div class="hidden md:flex items-center space-x-3 bg-white p-3 rounded-2xl shadow-lg border-3 border-purple-300">
                    <span class="text-lg font-bold text-purple-600">ğŸ¨ ì°½ ê°œìˆ˜:</span>
                    <button data-multi-cols="1" class="multi-col-btn px-4 py-2 rounded-xl border-3 border-purple-300 hover:bg-purple-100 transition duration-200 font-bold">1</button>
                    <button data-multi-cols="2" class="multi-col-btn px-4 py-2 rounded-xl border-3 border-purple-500 bg-purple-100 transition duration-200 font-bold">2</button>
                    <button data-multi-cols="3" class="multi-col-btn px-4 py-2 rounded-xl border-3 border-purple-300 hover:bg-purple-100 transition duration-200 font-bold">3</button>
                    <button data-multi-cols="4" class="multi-col-btn px-4 py-2 rounded-xl border-3 border-purple-300 hover:bg-purple-100 transition duration-200 font-bold">4</button>
                </div>
            </div>
            
            <!-- ë©€í‹°ë·° ì»¨í…Œì´ë„ˆ -->
            <div id="multi-view-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </main>
    </div>

    <!-- "ì˜í–ˆì–´ìš”!" í† ìŠ¤íŠ¸ ë©”ì‹œì§€ -->
    <div id="toast-message" class="fixed bottom-10 left-1/2 -translate-x-1/2 text-white px-8 py-4 rounded-full shadow-2xl text-2xl font-bold opacity-0 translate-y-5 z-50" style="background:#8f9bf5;">
        â­ ì˜í–ˆì–´ìš”! â­
    </div>
    
    <!-- "ë©‹ì§€ê²Œ í•´ëƒˆìŠµë‹ˆë‹¤!" ëŒ€í˜• ë©”ì‹œì§€ -->
    <div id="achievement-message" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 hidden z-50">
        <div class="bg-gradient-to-br from-yellow-200 via-pink-200 to-purple-200 rounded-3xl p-10 text-center transform scale-95 transition-all duration-500 shadow-2xl max-w-md mx-4 border-8 border-white">
            <div class="text-8xl mb-4 achievement-emoji">ğŸ‰</div>
            <h2 class="text-4xl font-bold text-purple-700 mb-4">ë©‹ì§€ê²Œ í•´ëƒˆì–´ìš”!</h2>
            <p class="text-xl text-purple-600 mb-6 font-bold" id="achievement-category"></p>
            <p class="text-7xl font-bold text-yellow-500 mb-8 animate-bounce">+1000 P</p>
            <button id="achievement-close-btn" class="bg-gradient-to-r from-pink-500 to-purple-500 text-white font-bold py-4 px-10 rounded-full hover:from-pink-600 hover:to-purple-600 transition duration-300 shadow-xl text-xl">
                ğŸ‘ í™•ì¸
            </button>
        </div>
    </div>

    <!-- ë©”ëª¨ ê´€ë¦¬ ëª¨ë‹¬ -->
    <div id="memo-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 opacity-0 hidden z-50">
        <div id="modal-content" class="w-full max-w-md p-8 rounded-3xl shadow-2xl transform scale-95 border" style="background:#fff;border-color:#d9dfff;">
            <h3 class="text-3xl font-bold mb-6 text-purple-600">âœï¸ ë©”ëª¨ ê´€ë¦¬</h3>
            <textarea id="modal-memo-text" rows="4" class="w-full px-5 py-3 border-3 border-purple-300 rounded-2xl focus:ring-4 focus:ring-yellow-300 transition duration-200 resize-none text-lg"></textarea>
            <input type="hidden" id="modal-memo-id">
            <div class="mt-6 flex flex-col space-y-3">
                <!-- ë²„íŠ¼ë“¤ -->
                <div class="flex space-x-2">
                    <button id="modal-save-btn" class="flex-1 text-white font-bold py-3 px-4 rounded-2xl transition duration-200 shadow text-lg" style="background:#8f9bf5;">
                        âœï¸ ìˆ˜ì •
                    </button>
                    <button id="modal-delete-btn" class="flex-1 text-white font-bold py-3 px-4 rounded-2xl transition duration-200 shadow text-lg" style="background:#f06272;">
                        ğŸ—‘ï¸ ì‚­ì œ
                    </button>
                </div>
                <div class="flex space-x-2">
                    <button id="modal-complete-btn" class="flex-1 text-white font-bold py-3 px-4 rounded-2xl transition duration-200 shadow text-lg" style="background:#34d48a;">
                        âœ… ì™„ë£Œ
                    </button>
                    <button id="modal-cancel-btn" class="flex-1 bg-white text-gray-900 font-bold py-3 px-4 rounded-2xl transition duration-200 shadow border text-lg" style="border-color:#d9dfff;">
                        âŒ ì·¨ì†Œ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // ìƒˆ ë²„ì „ ë°°í¬ ì‹œ 1íšŒ ìë™ ìƒˆë¡œê³ ì¹¨ì„ í†µí•´ ìºì‹œ ìš°íšŒ
        const APP_VERSION = '2025-10-27-1';
        (function ensureLatest() {
            try {
                const stored = localStorage.getItem('appVersion');
                const url = new URL(window.location.href);
                const v = url.searchParams.get('v');
                if (stored !== APP_VERSION) {
                    localStorage.setItem('appVersion', APP_VERSION);
                    if (v !== APP_VERSION) {
                        url.searchParams.set('v', APP_VERSION);
                        window.location.replace(url.toString());
                        return;
                    }
                }
            } catch (e) { /* noop */ }
        })();

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            getDocs,
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc,
            onSnapshot, 
            collection,
            query, 
            where, 
            orderBy,
            Timestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ì›”ë³„ ìƒ‰ìƒ ì„¤ì • ---
        const headerMonthColors = [
            'bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-500', 
            'bg-teal-500', 'bg-blue-500', 'bg-indigo-500', 'bg-purple-500', 
            'bg-pink-500', 'bg-red-600', 'bg-orange-600', 'bg-green-600'
        ];
        const categoryMonthColors = [
            'bg-red-100', 'bg-orange-100', 'bg-yellow-100', 'bg-green-100', 
            'bg-teal-100', 'bg-blue-100', 'bg-indigo-100', 'bg-purple-100', 
            'bg-pink-100', 'bg-red-200', 'bg-orange-200', 'bg-green-200'
        ];

        // --- ì „ì—­ ë³€ìˆ˜ ---
        let db, auth, appId, userId;
        let categoriesCollectionRef, memosCollectionRef, pointsDocRef;
        let currentPoints = 0;
        let isAuthReady = false;
        let currentCategory = null;
        let isMultiViewMode = false; // ë©€í‹°ë·° ì„ íƒ ëª¨ë“œ
        let selectedCategories = []; // ì„ íƒëœ ì¹´í…Œê³ ë¦¬ë“¤
        let currentMultiCols = 2; // ë©€í‹°ë·° ê¸°ë³¸ ì—´ ê°œìˆ˜
        let multiViewUnsubscribers = {}; // ë©€í‹°ë·° ë¦¬ìŠ¤ë„ˆë“¤
        let pointHistoryCollectionRef; // í¬ì¸íŠ¸ ë‚´ì—­
        let unsubscribePointHistory = null;
        
        let unsubscribeCategories = null; 
        let unsubscribePendingMemos = null; 

        // --- DOM ìš”ì†Œ ---
        const appHeader = document.getElementById('app-header');
        const pointsDisplay = document.getElementById('points-display');
        const toastMessage = document.getElementById('toast-message');

        const homePage = document.getElementById('home-page');
        const detailPage = document.getElementById('detail-page');
        const multiViewPage = document.getElementById('multi-view-page');
        const pointHistoryPage = document.getElementById('point-history-page');

        const categoryForm = document.getElementById('category-form');
        const categoryNameInput = document.getElementById('category-name-input');
        const categoryList = document.getElementById('category-list');

        const backToHomeBtn = document.getElementById('back-to-home');
        const backToHomeMultiBtn = document.getElementById('back-to-home-multi');
        const backToHomePointsBtn = document.getElementById('back-to-home-points');
        const multiViewBtn = document.getElementById('multi-view-btn');
        const multiViewContainer = document.getElementById('multi-view-container');
        const multiColButtons = document.querySelectorAll('.multi-col-btn');
        const pointHistoryBtn = document.getElementById('point-history-btn');
        const pointsBox = document.getElementById('points-box');
        const pointHistoryList = document.getElementById('point-history-list');
        const totalPointsDisplay = document.getElementById('total-points-display');
        const resetPointsBtn = document.getElementById('reset-points-btn');
        const achievementMessage = document.getElementById('achievement-message');
        const achievementCategory = document.getElementById('achievement-category');
        const achievementCloseBtn = document.getElementById('achievement-close-btn');
        
        const memoForm = document.getElementById('memo-form');
        const memoContentInput = document.getElementById('memo-content');
        const memoListPending = document.getElementById('memo-list-pending'); 

        const memoModal = document.getElementById('memo-modal');
        const modalContent = document.getElementById('modal-content');
        const modalMemoText = document.getElementById('modal-memo-text');
        const modalMemoId = document.getElementById('modal-memo-id');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalDeleteBtn = document.getElementById('modal-delete-btn');
        const modalCompleteBtn = document.getElementById('modal-complete-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        // --- í—¤ë” ìƒ‰ìƒ ì„¤ì • ---
        function setHeaderColor() {
            // ì›”ë³„ ìƒ‰ìƒ ëŒ€ì‹  ê³ ì • ë³´ë¼ìƒ‰ ë°°ê²½ì„ ì‚¬ìš©
            if (appHeader) {
                appHeader.style.background = '#b9c3ff';
            }
        }

        // --- Firebase ì´ˆê¸°í™” ---
        async function initFirebase() {
            const firebaseConfig = {
                apiKey: "AIzaSyBWRcoU1w3vJ81oBIYpFDHYw4IBDGnMgsQ",
                authDomain: "soeun-notes.firebaseapp.com",
                projectId: "soeun-notes",
                storageBucket: "soeun-notes.firebasestorage.app",
                messagingSenderId: "960037754876",
                appId: "1:960037754876:web:2cb07f38e29f69e7ffc479"
            };
            
            appId = "soeun-notes";

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // ê³ ì • ì‚¬ìš©ì ID ì‚¬ìš© (ëª¨ë“  ê¸°ê¸°ì—ì„œ ë™ì¼í•œ ë°ì´í„° ê³µìœ )
                userId = "soeun-shared-user";
                isAuthReady = true;
                console.log("Using fixed User ID:", userId);
                
                categoriesCollectionRef = collection(db, 'users', userId, 'categories');
                memosCollectionRef = collection(db, 'users', userId, 'memos');
                pointsDocRef = doc(db, 'users', userId, 'userData', 'points');
                pointHistoryCollectionRef = collection(db, 'users', userId, 'pointHistory');

                setupPointsListener();
                await checkAndSeedCategories();
                showHomePage();

            } catch (error) {
                console.error("Firebase Init Error:", error);
            }
        }

        // ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ ìƒì„±
        async function checkAndSeedCategories() {
            if (!categoriesCollectionRef) return;
            try {
                const snapshot = await getDocs(categoriesCollectionRef);
                if (snapshot.empty) {
                    console.log("Seeding default categories...");
                    await addDoc(categoriesCollectionRef, { name: "ì¼ë°˜" });
                    await addDoc(categoriesCollectionRef, { name: "ìš´ë™" });
                }
            } catch (error) {
                console.error("Error seeding categories: ", error);
            }
        }

        // --- ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ ---
        function showHomePage() {
            homePage.classList.remove('hidden');
            detailPage.classList.add('hidden');
            multiViewPage.classList.add('hidden');
            pointHistoryPage.classList.add('hidden');
            currentCategory = null;
            isMultiViewMode = false;
            selectedCategories = [];
            // í—¤ë”ëŠ” ì´ë¯¸ì§€ë§Œ í‘œì‹œí•˜ë¯€ë¡œ í…ìŠ¤íŠ¸ ë³€ê²½í•˜ì§€ ì•ŠìŒ
            multiViewBtn.textContent = 'ë©€í‹°ë·° ì„ íƒ';
            multiViewBtn.classList.remove('bg-red-500', 'hover:bg-red-600', 'text-white');
            multiViewBtn.classList.add('bg-white', 'hover:bg-gray-50', 'text-gray-900');

            if (unsubscribePendingMemos) unsubscribePendingMemos();
            if (unsubscribePointHistory) unsubscribePointHistory();
            Object.values(multiViewUnsubscribers).forEach(unsub => unsub());
            multiViewUnsubscribers = {};

            setupCategoryListener();
        }
        
        // í¬ì¸íŠ¸ ë‚´ì—­ í˜ì´ì§€ í‘œì‹œ
        function showPointHistoryPage() {
            homePage.classList.add('hidden');
            detailPage.classList.add('hidden');
            multiViewPage.classList.add('hidden');
            pointHistoryPage.classList.remove('hidden');
            // í—¤ë” í…ìŠ¤íŠ¸ ì‚¬ìš© ì•ˆ í•¨
            
            if (unsubscribeCategories) unsubscribeCategories();
            
            setupPointHistoryListener();
        }

        function showDetailPage(categoryName) {
            homePage.classList.add('hidden');
            detailPage.classList.remove('hidden');
            multiViewPage.classList.add('hidden');
            pointHistoryPage.classList.add('hidden');
            currentCategory = categoryName;
            
            memoContentInput.placeholder = `'${categoryName}'ì— ìƒˆ ë©”ëª¨ ì¶”ê°€...`;

            if (unsubscribeCategories) unsubscribeCategories();

            setupMemoListeners(categoryName);
        }
        
        // ë©€í‹°ë·° í˜ì´ì§€ í‘œì‹œ
        function showMultiViewPage() {
            if (selectedCategories.length === 0) {
                alert('ì¹´í…Œê³ ë¦¬ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                return;
            }
            
            homePage.classList.add('hidden');
            detailPage.classList.add('hidden');
            multiViewPage.classList.remove('hidden');
            pointHistoryPage.classList.add('hidden');
            // í—¤ë” í…ìŠ¤íŠ¸ ì‚¬ìš© ì•ˆ í•¨
            
            if (unsubscribeCategories) unsubscribeCategories();
            
            renderMultiView();
        }
        
        // ë©€í‹°ë·° ë Œë”ë§
        function renderMultiView() {
            multiViewContainer.innerHTML = '';
            
            // ì—´ ê°œìˆ˜ ì ìš©
            multiViewContainer.className = `grid grid-cols-1 md:grid-cols-${currentMultiCols} gap-6`;
            
            selectedCategories.forEach(categoryName => {
                const panel = document.createElement('div');
                panel.className = 'bg-white rounded-lg shadow-lg p-4 flex flex-col';
                panel.innerHTML = `
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <h3 class="text-lg font-bold">${escapeHTML(categoryName)}</h3>
                        <button class="remove-category-btn text-red-500 hover:text-red-700" data-category="${escapeHTML(categoryName)}">âœ•</button>
                    </div>
                    
                    <!-- ë©”ëª¨ ì…ë ¥ í¼ -->
                    <form class="multi-memo-form mb-4" data-category="${escapeHTML(categoryName)}">
                        <textarea rows="2" placeholder="ë©”ëª¨ ì‘ì„±..." class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200 resize-none"></textarea>
                        <button type="submit" class="w-full mt-2 text-gray-900 text-sm font-semibold py-2 px-3 rounded-lg transition duration-300" style="background-color: #f5f5dc;">
                            ì¶”ê°€
                        </button>
                    </form>
                    
                    <!-- ë©”ëª¨ ëª©ë¡ -->
                    <div class="memo-panel-list space-y-2 flex-1 overflow-y-auto" data-category="${escapeHTML(categoryName)}" style="max-height: 400px;"></div>
                `;
                
                multiViewContainer.appendChild(panel);
                
                // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ë©”ëª¨ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                setupMultiViewMemoListener(categoryName);
                
                // ë©”ëª¨ ì¶”ê°€ í¼ ì´ë²¤íŠ¸
                const form = panel.querySelector('.multi-memo-form');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const textarea = form.querySelector('textarea');
                    const content = textarea.value.trim();
                    
                    if (!content) return;
                    
                    try {
                        await addDoc(memosCollectionRef, {
                            content: content,
                            category: categoryName,
                            completed: false,
                            createdAt: Timestamp.now()
                        });
                        textarea.value = '';
                    } catch (error) {
                        console.error("Error adding memo in multi-view: ", error);
                    }
                });
            });
            
            // ì œê±° ë²„íŠ¼ ì´ë²¤íŠ¸
            document.querySelectorAll('.remove-category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const category = e.target.getAttribute('data-category');
                    selectedCategories = selectedCategories.filter(c => c !== category);
                    if (selectedCategories.length === 0) {
                        showHomePage();
                    } else {
                        renderMultiView();
                    }
                });
            });
        }
        
        // ë©€í‹°ë·° ë©”ëª¨ ë¦¬ìŠ¤ë„ˆ
        function setupMultiViewMemoListener(categoryName) {
            if (!isAuthReady || !memosCollectionRef) return;
            
            const memoQuery = query(
                memosCollectionRef,
                where("category", "==", categoryName),
                where("completed", "==", false)
            );
            
            const unsubscribe = onSnapshot(memoQuery, (snapshot) => {
                const listElement = document.querySelector(`.memo-panel-list[data-category="${categoryName}"]`);
                if (!listElement) return;
                
                listElement.innerHTML = '';
                
                if (snapshot.empty) {
                    listElement.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">ë©”ëª¨ ì—†ìŒ</p>';
                    return;
                }
                
                snapshot.docs.forEach(doc => {
                    const memo = doc.data();
                    const memoId = doc.id;
                    
                    const memoDiv = document.createElement('div');
                    memoDiv.className = 'p-3 bg-white rounded-lg cursor-pointer hover:shadow-lg transition duration-200 border border-gray-200';
                    memoDiv.dataset.id = memoId;
                    memoDiv.innerHTML = `
                        <p class="text-sm text-gray-900 break-words">${escapeHTML(memo.content)}</p>
                    `;
                    
                    memoDiv.addEventListener('click', () => openMemoModal(memoId, memo.content));
                    
                    listElement.appendChild(memoDiv);
                });
            }, (error) => console.error(`Multi-view memo snapshot error for ${categoryName}:`, error));
            
            multiViewUnsubscribers[categoryName] = unsubscribe;
        }
        
        // ë©€í‹°ë·° ì—´ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        function updateMultiViewColumns() {
            if (multiViewContainer) {
                multiViewContainer.className = `grid grid-cols-1 md:grid-cols-${currentMultiCols} gap-6`;
            }
            updateMultiColButtonStyles();
        }
        
        function updateMultiColButtonStyles() {
            multiColButtons.forEach(btn => {
                const cols = parseInt(btn.getAttribute('data-multi-cols'));
                if (cols === currentMultiCols) {
                    btn.classList.add('border-blue-500', 'bg-blue-50');
                    btn.classList.remove('border-gray-300');
                } else {
                    btn.classList.add('border-gray-300');
                    btn.classList.remove('border-blue-500', 'bg-blue-50');
                }
            });
        }

        // --- ë¦¬ìŠ¤ë„ˆ ì„¤ì • ---
        function setupCategoryListener() {
            if (!isAuthReady || !categoriesCollectionRef) return;

            console.log("Setting up category listener");
            if (unsubscribeCategories) unsubscribeCategories();

            unsubscribeCategories = onSnapshot(categoriesCollectionRef, renderCategories, (error) => {
                console.error("Category snapshot error:", error);
            });
        }

        function setupMemoListeners(categoryName) {
            if (!isAuthReady || !memosCollectionRef) return;

            console.log(`Setting up memo listeners for: ${categoryName}`);
            
            if (unsubscribePendingMemos) unsubscribePendingMemos();

            const pendingQuery = query(
                memosCollectionRef, 
                where("category", "==", categoryName),
                where("completed", "==", false)
            );
            unsubscribePendingMemos = onSnapshot(pendingQuery, (snapshot) => {
                renderMemos(snapshot, memoListPending);
            }, (error) => console.error("Pending memo snapshot error:", error));
        }

        function setupPointsListener() {
             if (!isAuthReady || !pointsDocRef) return;
            onSnapshot(pointsDocRef, renderPoints, (error) => {
                console.error("Points snapshot error:", error);
            });
            getDoc(pointsDocRef).then(renderPoints).catch(error => {
                console.error("Initial points fetch error:", error);
            });
        }
        
        // í¬ì¸íŠ¸ ë‚´ì—­ ë¦¬ìŠ¤ë„ˆ
        function setupPointHistoryListener() {
            if (!isAuthReady || !pointHistoryCollectionRef) return;
            
            if (unsubscribePointHistory) unsubscribePointHistory();
            
            const q = query(pointHistoryCollectionRef, orderBy("timestamp", "desc"));
            unsubscribePointHistory = onSnapshot(q, renderPointHistory, (error) => {
                console.error("Point history snapshot error:", error);
            });
        }

        // --- UI ë Œë”ë§ ---
        function renderCategories(snapshot) {
            categoryList.innerHTML = '';
            if (snapshot.empty) {
                categoryList.innerHTML = '<p class="text-gray-500">ì¹´í…Œê³ ë¦¬ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.</p>';
                return;
            }

            snapshot.docs.forEach(doc => {
                const category = doc.data();
                const categoryName = category.name;

                const card = document.createElement('div');
                card.className = 'p-6 rounded-2xl shadow-md cursor-pointer hover:shadow-lg transition-all duration-200 border bg-white';

                const contentWrap = document.createElement('div');
                contentWrap.className = 'flex-1';
                contentWrap.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="text-2xl font-extrabold text-gray-800 category-name" data-category-id="${doc.id}">${escapeHTML(categoryName)}</h3>
                            <p class="text-gray-500 text-base mt-2 pending-count font-bold">ê³„ì‚° ì¤‘...</p>
                        </div>
                        ${isMultiViewMode ? 
                            `<input type=\"checkbox\" class=\"category-checkbox w-6 h-6 mt-1\" data-category=\"${escapeHTML(categoryName)}\">` : 
                            `<button class=\"delete-category-btn w-9 h-9 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center text-red-500 text-xl font-bold shadow transition-all duration-150\" data-category-id=\"${doc.id}\" data-category-name=\"${escapeHTML(categoryName)}\">Ã—</button>`
                        }
                    </div>`;
                card.appendChild(contentWrap);

                updatePendingCount(card, categoryName);

                const categoryNameElement = card.querySelector('.category-name');

                if (!isMultiViewMode) {
                    // ì¼ë°˜ í´ë¦­: ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
                    card.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('category-name') && !e.target.classList.contains('delete-category-btn')) {
                            showDetailPage(categoryName);
                        }
                    });
                    
                    // ì¹´í…Œê³ ë¦¬ ì´ë¦„ ë”ë¸”í´ë¦­: ìˆ˜ì • ëª¨ë“œ
                    categoryNameElement.addEventListener('dblclick', (e) => {
                        e.stopPropagation();
                        editCategoryName(categoryNameElement, doc.id, categoryName);
                    });
                    
                    // ì‚­ì œ ë²„íŠ¼ í´ë¦­
                    const deleteBtn = card.querySelector('.delete-category-btn');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteCategory(doc.id, categoryName);
                        });
                    }
                } else {
                    const checkbox = card.querySelector('.category-checkbox');
                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            selectedCategories.push(categoryName);
                        } else {
                            selectedCategories = selectedCategories.filter(c => c !== categoryName);
                        }
                    });
                }

                categoryList.appendChild(card);
            });
        }

        async function updatePendingCount(cardElement, categoryName) {
            if (!memosCollectionRef) return;
            try {
                const q = query(memosCollectionRef, 
                    where("category", "==", categoryName), 
                    where("completed", "==", false)
                );
                const snapshot = await getDocs(q);
                const count = snapshot.size;
                
                const countElement = cardElement.querySelector('.pending-count');
                if (countElement) {
                    countElement.textContent = `${count}ê°œ ì§„í–‰ ì¤‘`;
                }
            } catch (error) {
                console.error(`Error fetching count for ${categoryName}:`, error);
                const countElement = cardElement.querySelector('.pending-count');
                if (countElement) {
                    countElement.textContent = `ê°œìˆ˜ ë¡œë“œ ì‹¤íŒ¨`;
                }
            }
        }

        function renderMemos(snapshot, listElement) {
            listElement.innerHTML = '';
            
            if (snapshot.empty) {
                const message = 'ğŸˆ ì•„ì§ í•  ì¼ì´ ì—†ì–´ìš”!';
                listElement.innerHTML = `<p class="text-purple-500 col-span-full text-center text-2xl font-bold">${message}</p>`;
                return;
            }

            snapshot.docs.forEach(doc => {
                const memo = doc.data();
                const memoId = doc.id;

                const iconColor = 'text-gray-400';
                const textStyle = 'text-gray-900';
                
                const memoDiv = document.createElement('div');
                memoDiv.className = 'p-4 rounded-2xl shadow-md cursor-pointer hover:shadow-lg transition-all duration-200 border bg-white';
                memoDiv.dataset.id = memoId;

                memoDiv.innerHTML = `<p class="${textStyle} break-words whitespace-pre-wrap text-base font-semibold">${escapeHTML(memo.content)}</p>`;

                memoDiv.addEventListener('click', () => openMemoModal(memoId, memo.content));
                
                listElement.appendChild(memoDiv);
            });
        }

        function renderPoints(docSnap) {
            currentPoints = (docSnap && docSnap.exists()) ? docSnap.data().value || 0 : 0;
            pointsDisplay.textContent = `${currentPoints} P`;
            if (totalPointsDisplay) {
                totalPointsDisplay.textContent = `${currentPoints} P`;
            }
        }
        
        // í¬ì¸íŠ¸ ë‚´ì—­ ë Œë”ë§
        function renderPointHistory(snapshot) {
            pointHistoryList.innerHTML = '';
            
            if (snapshot.empty) {
                pointHistoryList.innerHTML = '<p class="text-purple-500 text-center py-8 text-2xl font-bold">ğŸˆ ì•„ì§ ëª¨ì€ í¬ì¸íŠ¸ê°€ ì—†ì–´ìš”!</p>';
                return;
            }
            
            const history = [];
            snapshot.docs.forEach(doc => {
                history.push({ id: doc.id, ...doc.data() });
            });
            
            // ìµœì‹ ìˆœ ì •ë ¬
            history.sort((a, b) => {
                if (a.timestamp && b.timestamp) {
                    return b.timestamp.toMillis() - a.timestamp.toMillis();
                }
                return 0;
            });
            
            history.forEach(item => {
                const div = document.createElement('div');
                const bgGradient = item.points >= 1000 
                    ? 'bg-gradient-to-r from-yellow-200 to-orange-200' 
                    : 'bg-gradient-to-r from-green-200 to-blue-200';
                div.className = `${bgGradient} rounded-3xl p-6 shadow-lg flex justify-between items-center border-4 border-white transform hover:scale-105 transition-all duration-300`;
                
                const date = item.timestamp ? item.timestamp.toDate().toLocaleString('ko-KR') : 'ë‚ ì§œ ì—†ìŒ';
                const pointsClass = item.points >= 1000 ? 'text-yellow-600 text-3xl' : 'text-green-600 text-2xl';
                const icon = item.points >= 1000 ? 'ğŸ†' : 'â­';
                
                div.innerHTML = `
                    <div>
                        <p class="font-bold text-gray-900 text-xl">${escapeHTML(item.description || 'ë©”ëª¨ ì™„ë£Œ')}</p>
                        <p class="text-base text-gray-700 font-semibold mt-1">${date}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-4xl mr-2">${icon}</span>
                        <span class="${pointsClass} font-bold">+${item.points} P</span>
                    </div>
                `;
                
                pointHistoryList.appendChild(div);
            });
        }

        function showToast() {
            toastMessage.classList.remove('opacity-0', 'translate-y-5');
            toastMessage.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                toastMessage.classList.remove('opacity-100', 'translate-y-0');
                toastMessage.classList.add('opacity-0', 'translate-y-5');
            }, 2000);
            
            // ìŒì„± ì¬ìƒ (ì—¬ì ëª©ì†Œë¦¬)
            speakText("ì˜í–ˆì–´ìš”!");
        }
        
        // í…ìŠ¤íŠ¸ë¥¼ ìŒì„±ìœ¼ë¡œ ì¬ìƒí•˜ëŠ” í•¨ìˆ˜
        function speakText(text) {
            if ('speechSynthesis' in window) {
                // ê¸°ì¡´ ìŒì„±ì´ ì¬ìƒ ì¤‘ì´ë©´ ì¤‘ì§€
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ko-KR'; // í•œêµ­ì–´ ì„¤ì •
                utterance.rate = 1.0; // ì†ë„ (0.1 ~ 10)
                utterance.pitch = 1.2; // ìŒë†’ì´ (0 ~ 2, ë†’ì„ìˆ˜ë¡ ì—¬ì„±ìŠ¤ëŸ¬ì›€)
                utterance.volume = 1.0; // ë³¼ë¥¨ (0 ~ 1)
                
                // í•œêµ­ì–´ ì—¬ì„± ëª©ì†Œë¦¬ ì°¾ê¸°
                const voices = window.speechSynthesis.getVoices();
                const koreanFemaleVoice = voices.find(voice => 
                    voice.lang.includes('ko') && voice.name.includes('Female')
                ) || voices.find(voice => 
                    voice.lang.includes('ko')
                );
                
                if (koreanFemaleVoice) {
                    utterance.voice = koreanFemaleVoice;
                }
                
                window.speechSynthesis.speak(utterance);
            }
        }
        
        // ìŒì„± ëª©ë¡ ë¡œë“œ (í˜ì´ì§€ ë¡œë“œ ì‹œ)
        if ('speechSynthesis' in window) {
            // ì¼ë¶€ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìŒì„± ëª©ë¡ì´ ë¹„ë™ê¸°ë¡œ ë¡œë“œë¨
            window.speechSynthesis.onvoiceschanged = () => {
                window.speechSynthesis.getVoices();
            };
        }

        // --- ëª¨ë‹¬ í•¨ìˆ˜ ---
        function openMemoModal(memoId, content) {
            modalMemoId.value = memoId;
            modalMemoText.value = content;
            memoModal.classList.remove('hidden');
            setTimeout(() => {
                memoModal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
        }

        function hideMemoModal() {
            memoModal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                memoModal.classList.add('hidden');
            }, 300);
        }

        // --- ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
        
        // ì¹´í…Œê³ ë¦¬ ì´ë¦„ ìˆ˜ì •
        function editCategoryName(nameElement, categoryId, currentName) {
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'text-2xl font-bold text-gray-800 bg-white border-2 border-blue-500 rounded px-2 py-1 w-full';
            
            nameElement.replaceWith(input);
            input.focus();
            input.select();
            
            async function saveName() {
                const newName = input.value.trim();
                if (newName === '' || newName === currentName) {
                    const h3 = document.createElement('h3');
                    h3.className = 'text-2xl font-bold text-gray-800 category-name';
                    h3.dataset.categoryId = categoryId;
                    h3.textContent = currentName;
                    input.replaceWith(h3);
                    
                    h3.addEventListener('dblclick', (e) => {
                        e.stopPropagation();
                        editCategoryName(h3, categoryId, currentName);
                    });
                    return;
                }
                
                try {
                    const categoryRef = doc(db, 'users', userId, 'categories', categoryId);
                    await updateDoc(categoryRef, { name: newName });
                } catch (error) {
                    console.error("Error updating category name: ", error);
                    alert('ì¹´í…Œê³ ë¦¬ ì´ë¦„ ë³€ê²½ ì‹¤íŒ¨');
                }
            }
            
            input.addEventListener('blur', saveName);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                } else if (e.key === 'Escape') {
                    const h3 = document.createElement('h3');
                    h3.className = 'text-2xl font-bold text-gray-800 category-name';
                    h3.dataset.categoryId = categoryId;
                    h3.textContent = currentName;
                    input.replaceWith(h3);
                    
                    h3.addEventListener('dblclick', (e) => {
                        e.stopPropagation();
                        editCategoryName(h3, categoryId, currentName);
                    });
                }
            });
        }
        
        async function handleAddCategory(event) {
            event.preventDefault();
            if (!isAuthReady) return;
            const name = categoryNameInput.value.trim();
            if (name === '') return;

            try {
                await addDoc(categoriesCollectionRef, { name: name });
                categoryNameInput.value = '';
            } catch (error) {
                console.error("Error adding category: ", error);
            }
        }
        
        // ì¹´í…Œê³ ë¦¬ ì‚­ì œ
        async function deleteCategory(categoryId, categoryName) {
            if (!confirm(`"${categoryName}" ì¹´í…Œê³ ë¦¬ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê´€ë ¨ëœ ëª¨ë“  ë©”ëª¨ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                return;
            }
            
            try {
                // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  ë©”ëª¨ ì‚­ì œ
                const memosQuery = query(memosCollectionRef, where("category", "==", categoryName));
                const memosSnapshot = await getDocs(memosQuery);
                
                const deletePromises = [];
                memosSnapshot.docs.forEach(memoDoc => {
                    deletePromises.push(deleteDoc(doc(db, 'users', userId, 'memos', memoDoc.id)));
                });
                
                // ì¹´í…Œê³ ë¦¬ ì‚­ì œ
                deletePromises.push(deleteDoc(doc(db, 'users', userId, 'categories', categoryId)));
                
                await Promise.all(deletePromises);
                
                console.log(`Category "${categoryName}" and its memos deleted successfully`);
            } catch (error) {
                console.error("Error deleting category: ", error);
                alert('ì¹´í…Œê³ ë¦¬ ì‚­ì œ ì‹¤íŒ¨');
            }
        }

        async function handleAddMemo(event) {
            event.preventDefault();
            if (!isAuthReady || !currentCategory) return;
            const content = memoContentInput.value.trim();
            if (content === '') return;

            try {
                await addDoc(memosCollectionRef, { 
                    content: content,
                    category: currentCategory,
                    completed: false,
                    createdAt: Timestamp.now()
                });
                memoContentInput.value = '';
            } catch (error) {
                console.error("Error adding memo: ", error);
            }
        }

        // ë©”ëª¨ ìˆ˜ì •
        async function handleUpdateMemo() {
            const docId = modalMemoId.value;
            const newContent = modalMemoText.value.trim();
            if (!isAuthReady || !docId || newContent === '') return;

            const docRef = doc(db, 'users', userId, 'memos', docId);
            try {
                await updateDoc(docRef, {
                    content: newContent
                });
                hideMemoModal();
            } catch (error) {
                console.error("Error updating memo: ", error);
            }
        }

        // ë©”ëª¨ ì‚­ì œ (í¬ì¸íŠ¸ ì—†ìŒ)
        async function handleDeleteMemo() {
            const docId = modalMemoId.value;
            if (!isAuthReady || !docId) return;

            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const docRef = doc(db, 'users', userId, 'memos', docId);
            try {
                await deleteDoc(docRef);
                hideMemoModal();
                showToast(); // "ì˜í–ˆì–´ìš”!" ë©”ì‹œì§€ í‘œì‹œ
            } catch (error) {
                console.error("Error deleting memo: ", error);
            }
        }

        // ë©”ëª¨ ì™„ë£Œ (í¬ì¸íŠ¸ ì ë¦½ + ì‚­ì œ)
        async function completeAndRemoveMemo() {
            const docId = modalMemoId.value;
            if (!isAuthReady || !docId) return;

            try {
                // ë©”ëª¨ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const memoRef = doc(db, 'users', userId, 'memos', docId);
                const memoSnap = await getDoc(memoRef);
                const memoData = memoSnap.data();
                const memoCategory = memoData.category;
                
                // í¬ì¸íŠ¸ ì ë¦½
                const newPoints = currentPoints + 500;
                await setDoc(pointsDocRef, { value: newPoints });
                
                // í¬ì¸íŠ¸ ë‚´ì—­ ì¶”ê°€
                await addDoc(pointHistoryCollectionRef, {
                    points: 500,
                    description: `${memoCategory} - ë©”ëª¨ ì™„ë£Œ`,
                    timestamp: Timestamp.now()
                });
                
                showToast(); // "ì˜í–ˆì–´ìš”!" ë©”ì‹œì§€

                // DBì—ì„œ ë¬¸ì„œ ì‚­ì œ
                await deleteDoc(memoRef); 
                
                // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ë‚¨ì€ ë©”ëª¨ í™•ì¸
                await checkCategoryCompletion(memoCategory);
                
                hideMemoModal();
            } catch (error) {
                console.error("Error completing and removing memo: ", error);
            }
        }
        
        // ì¹´í…Œê³ ë¦¬ ì™„ë£Œ ì²´í¬
        async function checkCategoryCompletion(categoryName) {
            try {
                const q = query(
                    memosCollectionRef,
                    where("category", "==", categoryName),
                    where("completed", "==", false)
                );
                const snapshot = await getDocs(q);
                
                // ë‚¨ì€ ë©”ëª¨ê°€ ì—†ìœ¼ë©´
                if (snapshot.empty) {
                    // 1000 í¬ì¸íŠ¸ ì ë¦½
                    const newPoints = currentPoints + 1000;
                    await setDoc(pointsDocRef, { value: newPoints });
                    
                    // í¬ì¸íŠ¸ ë‚´ì—­ ì¶”ê°€
                    await addDoc(pointHistoryCollectionRef, {
                        points: 1000,
                        description: `${categoryName} - ëª¨ë‘ ì™„ë£Œ! ğŸ‰`,
                        timestamp: Timestamp.now()
                    });
                    
                    // íŠ¹ë³„ ë©”ì‹œì§€ í‘œì‹œ
                    showAchievementMessage(categoryName);
                }
            } catch (error) {
                console.error("Error checking category completion: ", error);
            }
        }
        
        // "ë©‹ì§€ê²Œ í•´ëƒˆìŠµë‹ˆë‹¤!" ë©”ì‹œì§€ í‘œì‹œ
        function showAchievementMessage(categoryName) {
            achievementCategory.textContent = `${categoryName} ì¹´í…Œê³ ë¦¬ì˜ ëª¨ë“  ë©”ëª¨ë¥¼ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤!`;
            achievementMessage.classList.remove('hidden');
            setTimeout(() => {
                achievementMessage.classList.remove('opacity-0');
                achievementMessage.querySelector('div').classList.remove('scale-95');
                achievementMessage.querySelector('div').classList.add('scale-100');
            }, 10);
            
            // ìŒì„± ì¬ìƒ
            speakText("ë©‹ì§€ê²Œ í•´ëƒˆìŠµë‹ˆë‹¤!");
        }
        
        function hideAchievementMessage() {
            achievementMessage.classList.add('opacity-0');
            achievementMessage.querySelector('div').classList.remove('scale-100');
            achievementMessage.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                achievementMessage.classList.add('hidden');
            }, 300);
        }
        
        // í¬ì¸íŠ¸ ì´ˆê¸°í™”
        async function resetPoints() {
            if (!confirm('ì •ë§ë¡œ ëª¨ë“  í¬ì¸íŠ¸ì™€ ì ë¦½ ë‚´ì—­ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                return;
            }
            
            try {
                // í¬ì¸íŠ¸ë¥¼ 0ìœ¼ë¡œ ì„¤ì •
                await setDoc(pointsDocRef, { value: 0 });
                
                // ëª¨ë“  í¬ì¸íŠ¸ ë‚´ì—­ ì‚­ì œ
                const historySnapshot = await getDocs(pointHistoryCollectionRef);
                const deletePromises = [];
                historySnapshot.docs.forEach(historyDoc => {
                    deletePromises.push(deleteDoc(doc(db, 'users', userId, 'pointHistory', historyDoc.id)));
                });
                
                await Promise.all(deletePromises);
                
                alert('í¬ì¸íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (error) {
                console.error("Error resetting points: ", error);
                alert('í¬ì¸íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨');
            }
        }

        // --- ìœ í‹¸ë¦¬í‹° ---
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function(m) {
                return {'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#39;'}[m];
            });
        }

        // --- ì•± ì‹œì‘ ---
        categoryForm.addEventListener('submit', handleAddCategory);
        memoForm.addEventListener('submit', handleAddMemo);
        backToHomeBtn.addEventListener('click', showHomePage);
        backToHomeMultiBtn.addEventListener('click', showHomePage);
        backToHomePointsBtn.addEventListener('click', showHomePage);
        pointHistoryBtn.addEventListener('click', showPointHistoryPage);
        pointsBox.addEventListener('click', showPointHistoryPage);
        resetPointsBtn.addEventListener('click', resetPoints);
        achievementCloseBtn.addEventListener('click', hideAchievementMessage);
        
        // ë©€í‹°ë·° ë²„íŠ¼ í´ë¦­
        multiViewBtn.addEventListener('click', () => {
            if (!isMultiViewMode) {
                isMultiViewMode = true;
                selectedCategories = [];
                multiViewBtn.textContent = 'ì„ íƒ ì™„ë£Œ';
                multiViewBtn.classList.remove('bg-white', 'hover:bg-gray-50', 'text-gray-900');
                multiViewBtn.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white');
                setupCategoryListener(); // ë‹¤ì‹œ ë Œë”ë§
            } else {
                showMultiViewPage();
            }
        });
        
        // ë©€í‹°ë·° ì—´ ê°œìˆ˜ ë²„íŠ¼
        multiColButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                currentMultiCols = parseInt(btn.getAttribute('data-multi-cols'));
                updateMultiViewColumns();
            });
        });

        // ëª¨ë‹¬ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ
        modalSaveBtn.addEventListener('click', handleUpdateMemo); // ìˆ˜ì •
        modalDeleteBtn.addEventListener('click', handleDeleteMemo); // ì‚­ì œ
        modalCompleteBtn.addEventListener('click', completeAndRemoveMemo); // ì™„ë£Œ
        modalCancelBtn.addEventListener('click', hideMemoModal); // ì·¨ì†Œ
        
        // ëª¨ë‹¬ ë°”ê¹¥ ì˜ì—­ í´ë¦­ ì‹œ ë‹«ê¸°
        memoModal.addEventListener('click', (e) => {
            if (e.target === memoModal) {
                hideMemoModal();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            setHeaderColor();
            initFirebase();
        });

    </script>
</body>
</html>
