<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>메모 포인트 앱</title>
    <!-- Tailwind CSS 로드 -->
    <script src="https://cdn.tailwindcss.com?v=2"></script>
    <style>
        /* 어린이용 귀여운 폰트 */
        @import url('https://fonts.googleapis.com/css2?family=Gamja+Flower&family=Nanum+Pen+Script&display=swap');
        
        body {
            font-family: "Gamja Flower", cursive;
			background: #eff2ff;
            background-attachment: fixed;
        }
        
        /* 큰 텍스트 */
        h1, h2, h3 {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }
        
        /* "잘했어요!" 메시지 트랜지션 */
        #toast-message {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            font-size: 1.5rem;
            animation: bounce 0.5s ease-in-out;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        /* textarea 포커스 시 그림자 강조 */
        textarea:focus-within {
            box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.5);
        }
        
        /* 모달 트랜지션 */
        #memo-modal {
            transition: opacity 0.3s ease-in-out;
        }
        #modal-content {
            transition: transform 0.3s ease-in-out;
            border: 4px solid #ffd700;
        }
        
        /* 버튼 호버 효과 */
        button:hover {
            transform: scale(1.05);
            transition: transform 0.2s;
        }
        
        /* 카드 효과 */
        .category-card {
            border: 3px solid #fff;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }
        
        /* 귀여운 애니메이션 */
        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-5deg); }
            75% { transform: rotate(5deg); }
        }
        
        .achievement-emoji {
            animation: wiggle 0.5s ease-in-out infinite;
        }
    </style>
</head>
<body class="min-h-screen text-gray-800">

    <!-- 전체 래퍼 -->
    <div class="container mx-auto max-w-7xl p-4">

        <!-- 헤더: 타이틀 및 포인트 (항상 보임) -->
		<header id="app-header" class="flex justify-between items-center mb-8 p-6 rounded-3xl shadow-lg transition-colors duration-500" style="background: #b9c3ff;">
			<div class="w-20"></div>
			<div id="header-image-wrap" class="flex-1 flex items-center justify-center">
				<img src="soeun-header.png" alt="header image" class="h-20 w-20 object-cover rounded-full shadow"/>
			</div>
			<div id="points-wrap" class="flex items-center gap-4">
				<button id="point-history-btn" class="hidden md:block bg-white bg-opacity-90 hover:bg-opacity-100 text-purple-600 font-bold py-3 px-6 rounded-full transition duration-300 text-lg shadow-lg">⭐ 포인트 내역</button>
				<div class="text-right cursor-pointer bg-white bg-opacity-90 p-4 rounded-2xl shadow-lg" id="points-box">
					<span class="text-sm text-purple-600 font-bold">🏆 총 포인트</span>
					<p id="points-display" class="text-3xl font-bold text-purple-600">0 P</p>
				</div>
			</div>
 		</header>

        <!-- 홈 페이지: 카테고리 대시보드 -->
        <main id="home-page">
            <!-- 새 카테고리 추가 폼 -->
			<form id="category-form" class="bg-white p-6 rounded-3xl shadow-lg mb-8 flex space-x-3 border-2" style="border-color:#d9dfff;">
                <input type="text" id="category-name-input" placeholder="✏️ 새로운 주제를 만들어보세요!" class="w-full px-5 py-3 border-3 border-purple-300 rounded-2xl focus:ring-4 focus:ring-yellow-300 transition duration-200 text-lg">
				<button type="submit" class="text-white font-extrabold py-3 px-6 rounded-2xl transition duration-300 shadow-lg whitespace-nowrap text-lg" style="background-color:#34d48a;">
					➕ 추가하기
				</button>
            </form>

            <!-- 카테고리 목록 헤더 및 선택 모드 -->
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">📚 내 주제 목록</h2>
				<button id="multi-view-btn" class="bg-white text-gray-900 font-bold py-3 px-6 rounded-full border transition duration-200 shadow text-lg" style="border-color:#d9dfff;">
                    🎯 여러개 보기
                </button>
            </div>
            
            <!-- 카테고리 목록 -->
            <div id="category-list" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
        </main>

        <!-- 상세 페이지: 단일 카테고리 메모 목록 -->
        <main id="detail-page" class="hidden">
            <button id="back-to-home" class="mb-2 bg-white text-gray-900 font-bold py-3 px-6 rounded-full shadow transition duration-200 text-lg border" style="border-color:#d9dfff;">
                🏠 홈으로 돌아가기
            </button>
            <h2 id="detail-category-title" class="text-2xl font-extrabold text-gray-800 mb-4"></h2>

			<form id="memo-form" class="bg-white p-6 rounded-3xl shadow-lg mb-8 border-2" style="border-color:#d9dfff;">
				<textarea id="memo-content" rows="3" placeholder="" class="w-full px-5 py-3 border-2 rounded-2xl focus:ring-4 transition duration-200 resize-none text-lg" style="border-color:#d9dfff;"></textarea>
				<button type="submit" class="w-full mt-4 text-white font-extrabold py-4 px-6 rounded-2xl transition duration-300 shadow-lg flex items-center justify-center text-lg" style="background-color:#34d48a;">
					<svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
						<rect x="5" y="3" width="14" height="18" rx="2" fill="white" fill-opacity="0.2"/>
						<path d="M8 7h8M8 11h8M8 15h5" stroke="white" stroke-width="1.8" stroke-linecap="round"/>
					</svg>
					꾹! 저장하기
				</button>
			</form>

            <h3 class="text-3xl font-bold mb-6 text-gray-800">📝 할 일 목록</h3>
            <div id="memo-list-pending" class="grid grid-cols-1 gap-4"></div>
        </main>

        <!-- 포인트 내역 페이지 -->
        <main id="point-history-page" class="hidden">
            <button id="back-to-home-points" class="mb-6 bg-white text-gray-900 font-bold py-3 px-6 rounded-full shadow transition duration-200 text-lg border" style="border-color:#d9dfff;">
                🏠 홈으로 돌아가기
            </button>
            
            <h2 class="text-4xl font-bold mb-6 text-purple-600">⭐ 포인트 내역</h2>
            
            <div class="rounded-3xl shadow p-8 mb-8 border" style="background:#fff;border-color:#d9dfff;">
                <div class="text-center">
                    <p class="text-gray-700 text-xl mb-3 font-bold">🏆 모은 포인트</p>
                    <p id="total-points-display" class="text-6xl font-extrabold text-purple-600 mb-6">0 P</p>
                    <button id="reset-points-btn" class="bg-white text-gray-900 font-bold py-3 px-8 rounded-full transition duration-200 shadow border text-lg" style="border-color:#d9dfff;">
                        🔄 포인트 초기화
                    </button>
                </div>
            </div>
            
            <div id="point-history-list" class="space-y-4"></div>
        </main>

        <!-- 멀티뷰 페이지: 여러 카테고리 동시에 보기 -->
        <main id="multi-view-page" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <button id="back-to-home-multi" class="bg-gradient-to-r from-orange-400 to-red-400 text-white hover:from-orange-500 hover:to-red-500 font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 text-lg">
                    🏠 홈으로 돌아가기
                </button>
                <!-- 열 개수 선택 -->
                <div class="hidden md:flex items-center space-x-3 bg-white p-3 rounded-2xl shadow-lg border-3 border-purple-300">
                    <span class="text-lg font-bold text-purple-600">🎨 창 개수:</span>
                    <button data-multi-cols="1" class="multi-col-btn px-4 py-2 rounded-xl border-3 border-purple-300 hover:bg-purple-100 transition duration-200 font-bold">1</button>
                    <button data-multi-cols="2" class="multi-col-btn px-4 py-2 rounded-xl border-3 border-purple-500 bg-purple-100 transition duration-200 font-bold">2</button>
                    <button data-multi-cols="3" class="multi-col-btn px-4 py-2 rounded-xl border-3 border-purple-300 hover:bg-purple-100 transition duration-200 font-bold">3</button>
                    <button data-multi-cols="4" class="multi-col-btn px-4 py-2 rounded-xl border-3 border-purple-300 hover:bg-purple-100 transition duration-200 font-bold">4</button>
                </div>
            </div>
            
            <!-- 멀티뷰 컨테이너 -->
            <div id="multi-view-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </main>
    </div>

    <!-- "잘했어요!" 토스트 메시지 -->
    <div id="toast-message" class="fixed bottom-10 left-1/2 -translate-x-1/2 text-white px-8 py-4 rounded-full shadow-2xl text-2xl font-bold opacity-0 translate-y-5 z-50" style="background:#8f9bf5;">
        ⭐ 잘했어요! ⭐
    </div>
    
    <!-- "멋지게 해냈습니다!" 대형 메시지 -->
    <div id="achievement-message" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 hidden z-50">
        <div class="bg-gradient-to-br from-yellow-200 via-pink-200 to-purple-200 rounded-3xl p-10 text-center transform scale-95 transition-all duration-500 shadow-2xl max-w-md mx-4 border-8 border-white">
            <div class="text-8xl mb-4 achievement-emoji">🎉</div>
            <h2 class="text-4xl font-bold text-purple-700 mb-4">멋지게 해냈어요!</h2>
            <p class="text-xl text-purple-600 mb-6 font-bold" id="achievement-category"></p>
            <p class="text-7xl font-bold text-yellow-500 mb-8 animate-bounce">+1000 P</p>
            <button id="achievement-close-btn" class="bg-gradient-to-r from-pink-500 to-purple-500 text-white font-bold py-4 px-10 rounded-full hover:from-pink-600 hover:to-purple-600 transition duration-300 shadow-xl text-xl">
                👍 확인
            </button>
        </div>
    </div>

    <!-- 메모 관리 모달 -->
    <div id="memo-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 opacity-0 hidden z-50">
        <div id="modal-content" class="w-full max-w-md p-8 rounded-3xl shadow-2xl transform scale-95 border" style="background:#fff;border-color:#d9dfff;">
            <h3 class="text-3xl font-bold mb-6 text-purple-600">✏️ 메모 관리</h3>
            <textarea id="modal-memo-text" rows="4" class="w-full px-5 py-3 border-3 border-purple-300 rounded-2xl focus:ring-4 focus:ring-yellow-300 transition duration-200 resize-none text-lg"></textarea>
            <input type="hidden" id="modal-memo-id">
            <div class="mt-6 flex flex-col space-y-3">
                <!-- 버튼들 -->
                <div class="flex space-x-2">
                    <button id="modal-save-btn" class="flex-1 text-white font-bold py-3 px-4 rounded-2xl transition duration-200 shadow text-lg" style="background:#8f9bf5;">
                        ✏️ 수정
                    </button>
                    <button id="modal-delete-btn" class="flex-1 text-white font-bold py-3 px-4 rounded-2xl transition duration-200 shadow text-lg" style="background:#f06272;">
                        🗑️ 삭제
                    </button>
                </div>
                <div class="flex space-x-2">
                    <button id="modal-complete-btn" class="flex-1 text-white font-bold py-3 px-4 rounded-2xl transition duration-200 shadow text-lg" style="background:#34d48a;">
                        ✅ 완료
                    </button>
                    <button id="modal-cancel-btn" class="flex-1 bg-white text-gray-900 font-bold py-3 px-4 rounded-2xl transition duration-200 shadow border text-lg" style="border-color:#d9dfff;">
                        ❌ 취소
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // 새 버전 배포 시 1회 자동 새로고침을 통해 캐시 우회
        const APP_VERSION = '2025-10-27-1';
        (function ensureLatest() {
            try {
                const stored = localStorage.getItem('appVersion');
                const url = new URL(window.location.href);
                const v = url.searchParams.get('v');
                if (stored !== APP_VERSION) {
                    localStorage.setItem('appVersion', APP_VERSION);
                    if (v !== APP_VERSION) {
                        url.searchParams.set('v', APP_VERSION);
                        window.location.replace(url.toString());
                        return;
                    }
                }
            } catch (e) { /* noop */ }
        })();

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            getDocs,
            setDoc, 
            addDoc, 
            updateDoc, 
            deleteDoc,
            onSnapshot, 
            collection,
            query, 
            where, 
            orderBy,
            Timestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 월별 색상 설정 ---
        const headerMonthColors = [
            'bg-red-500', 'bg-orange-500', 'bg-yellow-500', 'bg-green-500', 
            'bg-teal-500', 'bg-blue-500', 'bg-indigo-500', 'bg-purple-500', 
            'bg-pink-500', 'bg-red-600', 'bg-orange-600', 'bg-green-600'
        ];
        const categoryMonthColors = [
            'bg-red-100', 'bg-orange-100', 'bg-yellow-100', 'bg-green-100', 
            'bg-teal-100', 'bg-blue-100', 'bg-indigo-100', 'bg-purple-100', 
            'bg-pink-100', 'bg-red-200', 'bg-orange-200', 'bg-green-200'
        ];

        // --- 전역 변수 ---
        let db, auth, appId, userId;
        let categoriesCollectionRef, memosCollectionRef, pointsDocRef;
        let currentPoints = 0;
        let isAuthReady = false;
        let currentCategory = null;
        let isMultiViewMode = false; // 멀티뷰 선택 모드
        let selectedCategories = []; // 선택된 카테고리들
        let currentMultiCols = 2; // 멀티뷰 기본 열 개수
        let multiViewUnsubscribers = {}; // 멀티뷰 리스너들
        let pointHistoryCollectionRef; // 포인트 내역
        let unsubscribePointHistory = null;
        
        let unsubscribeCategories = null; 
        let unsubscribePendingMemos = null; 

        // --- DOM 요소 ---
        const appHeader = document.getElementById('app-header');
        const pointsDisplay = document.getElementById('points-display');
        const toastMessage = document.getElementById('toast-message');

        const homePage = document.getElementById('home-page');
        const detailPage = document.getElementById('detail-page');
        const multiViewPage = document.getElementById('multi-view-page');
        const pointHistoryPage = document.getElementById('point-history-page');

        const categoryForm = document.getElementById('category-form');
        const categoryNameInput = document.getElementById('category-name-input');
        const categoryList = document.getElementById('category-list');

        const backToHomeBtn = document.getElementById('back-to-home');
        const backToHomeMultiBtn = document.getElementById('back-to-home-multi');
        const backToHomePointsBtn = document.getElementById('back-to-home-points');
        const multiViewBtn = document.getElementById('multi-view-btn');
        const multiViewContainer = document.getElementById('multi-view-container');
        const multiColButtons = document.querySelectorAll('.multi-col-btn');
        const pointHistoryBtn = document.getElementById('point-history-btn');
        const pointsBox = document.getElementById('points-box');
        const pointHistoryList = document.getElementById('point-history-list');
        const totalPointsDisplay = document.getElementById('total-points-display');
        const resetPointsBtn = document.getElementById('reset-points-btn');
        const achievementMessage = document.getElementById('achievement-message');
        const achievementCategory = document.getElementById('achievement-category');
        const achievementCloseBtn = document.getElementById('achievement-close-btn');
        
        const memoForm = document.getElementById('memo-form');
        const memoContentInput = document.getElementById('memo-content');
        const memoListPending = document.getElementById('memo-list-pending'); 
        const detailCategoryTitle = document.getElementById('detail-category-title');

        const memoModal = document.getElementById('memo-modal');
        const modalContent = document.getElementById('modal-content');
        const modalMemoText = document.getElementById('modal-memo-text');
        const modalMemoId = document.getElementById('modal-memo-id');
        const modalSaveBtn = document.getElementById('modal-save-btn');
        const modalDeleteBtn = document.getElementById('modal-delete-btn');
        const modalCompleteBtn = document.getElementById('modal-complete-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        // --- 헤더 색상 설정 ---
        function setHeaderColor() {
            // 월별 색상 대신 고정 보라색 배경을 사용
            if (appHeader) {
                appHeader.style.background = '#b9c3ff';
            }
        }

        // --- Firebase 초기화 ---
        async function initFirebase() {
            const firebaseConfig = {
                apiKey: "AIzaSyBWRcoU1w3vJ81oBIYpFDHYw4IBDGnMgsQ",
                authDomain: "soeun-notes.firebaseapp.com",
                projectId: "soeun-notes",
                storageBucket: "soeun-notes.firebasestorage.app",
                messagingSenderId: "960037754876",
                appId: "1:960037754876:web:2cb07f38e29f69e7ffc479"
            };
            
            appId = "soeun-notes";

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 고정 사용자 ID 사용 (모든 기기에서 동일한 데이터 공유)
                userId = "soeun-shared-user";
                isAuthReady = true;
                console.log("Using fixed User ID:", userId);
                
                categoriesCollectionRef = collection(db, 'users', userId, 'categories');
                memosCollectionRef = collection(db, 'users', userId, 'memos');
                pointsDocRef = doc(db, 'users', userId, 'userData', 'points');
                pointHistoryCollectionRef = collection(db, 'users', userId, 'pointHistory');

                setupPointsListener();
                await checkAndSeedCategories();
                showHomePage();

            } catch (error) {
                console.error("Firebase Init Error:", error);
            }
        }

        // 기본 카테고리 생성
        async function checkAndSeedCategories() {
            if (!categoriesCollectionRef) return;
            try {
                const snapshot = await getDocs(categoriesCollectionRef);
                if (snapshot.empty) {
                    console.log("Seeding default categories...");
                    await addDoc(categoriesCollectionRef, { name: "일반" });
                    await addDoc(categoriesCollectionRef, { name: "운동" });
                }
            } catch (error) {
                console.error("Error seeding categories: ", error);
            }
        }

        // --- 네비게이션 함수 ---
        function showHomePage() {
            homePage.classList.remove('hidden');
            detailPage.classList.add('hidden');
            multiViewPage.classList.add('hidden');
            pointHistoryPage.classList.add('hidden');
            currentCategory = null;
            isMultiViewMode = false;
            selectedCategories = [];
            // 헤더는 홈에서 표시
            if (appHeader) appHeader.style.display = '';
            multiViewBtn.textContent = '멀티뷰 선택';
            multiViewBtn.classList.remove('bg-red-500', 'hover:bg-red-600', 'text-white');
            multiViewBtn.classList.add('bg-white', 'hover:bg-gray-50', 'text-gray-900');

            if (unsubscribePendingMemos) unsubscribePendingMemos();
            if (unsubscribePointHistory) unsubscribePointHistory();
            Object.values(multiViewUnsubscribers).forEach(unsub => unsub());
            multiViewUnsubscribers = {};

            setupCategoryListener();
        }
        
        // 포인트 내역 페이지 표시
        function showPointHistoryPage() {
            homePage.classList.add('hidden');
            detailPage.classList.add('hidden');
            multiViewPage.classList.add('hidden');
            pointHistoryPage.classList.remove('hidden');
            // 헤더는 표시
            if (appHeader) appHeader.style.display = '';
            
            if (unsubscribeCategories) unsubscribeCategories();
            
            setupPointHistoryListener();
        }

        function showDetailPage(categoryName) {
            homePage.classList.add('hidden');
            detailPage.classList.remove('hidden');
            multiViewPage.classList.add('hidden');
            pointHistoryPage.classList.add('hidden');
            currentCategory = categoryName;
            // 상세 페이지에서는 헤더 숨김
            if (appHeader) appHeader.style.display = 'none';
            
            memoContentInput.placeholder = `'${categoryName}'에 새 메모 추가...`;
            const titleEl = document.getElementById('detail-category-title');
            if (titleEl) titleEl.textContent = categoryName;

            if (unsubscribeCategories) unsubscribeCategories();

            setupMemoListeners(categoryName);
        }
        
        // 멀티뷰 페이지 표시
        function showMultiViewPage() {
            if (selectedCategories.length === 0) {
                alert('카테고리를 선택해주세요!');
                return;
            }
            
            homePage.classList.add('hidden');
            detailPage.classList.add('hidden');
            multiViewPage.classList.remove('hidden');
            pointHistoryPage.classList.add('hidden');
            // 헤더는 표시
            if (appHeader) appHeader.style.display = '';
            
            if (unsubscribeCategories) unsubscribeCategories();
            
            renderMultiView();
        }
        
        // 멀티뷰 렌더링
        function renderMultiView() {
            multiViewContainer.innerHTML = '';
            
            // 열 개수 적용
            multiViewContainer.className = `grid grid-cols-1 md:grid-cols-${currentMultiCols} gap-6`;
            
            selectedCategories.forEach(categoryName => {
                const panel = document.createElement('div');
                panel.className = 'bg-white rounded-lg shadow-lg p-4 flex flex-col';
                panel.innerHTML = `
                    <div class="flex justify-between items-center mb-4 border-b pb-3">
                        <h3 class="text-lg font-bold">${escapeHTML(categoryName)}</h3>
                        <button class="remove-category-btn text-red-500 hover:text-red-700" data-category="${escapeHTML(categoryName)}">✕</button>
                    </div>
                    
                    <!-- 메모 입력 폼 -->
                    <form class="multi-memo-form mb-4" data-category="${escapeHTML(categoryName)}">
                        <textarea rows="2" placeholder="메모 작성..." class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200 resize-none"></textarea>
                        <button type="submit" class="w-full mt-2 text-gray-900 text-sm font-semibold py-2 px-3 rounded-lg transition duration-300" style="background-color: #f5f5dc;">
                            추가
                        </button>
                    </form>
                    
                    <!-- 메모 목록 -->
                    <div class="memo-panel-list space-y-2 flex-1 overflow-y-auto" data-category="${escapeHTML(categoryName)}" style="max-height: 400px;"></div>
                `;
                
                multiViewContainer.appendChild(panel);
                
                // 해당 카테고리의 메모 리스너 설정
                setupMultiViewMemoListener(categoryName);
                
                // 메모 추가 폼 이벤트
                const form = panel.querySelector('.multi-memo-form');
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const textarea = form.querySelector('textarea');
                    const content = textarea.value.trim();
                    
                    if (!content) return;
                    
                    try {
                        await addDoc(memosCollectionRef, {
                            content: content,
                            category: categoryName,
                            completed: false,
                            createdAt: Timestamp.now()
                        });
                        textarea.value = '';
                    } catch (error) {
                        console.error("Error adding memo in multi-view: ", error);
                    }
                });
            });
            
            // 제거 버튼 이벤트
            document.querySelectorAll('.remove-category-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const category = e.target.getAttribute('data-category');
                    selectedCategories = selectedCategories.filter(c => c !== category);
                    if (selectedCategories.length === 0) {
                        showHomePage();
                    } else {
                        renderMultiView();
                    }
                });
            });
        }
        
        // 멀티뷰 메모 리스너
        function setupMultiViewMemoListener(categoryName) {
            if (!isAuthReady || !memosCollectionRef) return;
            
            const memoQuery = query(
                memosCollectionRef,
                where("category", "==", categoryName),
                where("completed", "==", false)
            );
            
            const unsubscribe = onSnapshot(memoQuery, (snapshot) => {
                const listElement = document.querySelector(`.memo-panel-list[data-category="${categoryName}"]`);
                if (!listElement) return;
                
                listElement.innerHTML = '';
                
                if (snapshot.empty) {
                    listElement.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">메모 없음</p>';
                    return;
                }
                
                snapshot.docs.forEach(doc => {
                    const memo = doc.data();
                    const memoId = doc.id;
                    
                    const memoDiv = document.createElement('div');
                    memoDiv.className = 'p-3 bg-white rounded-lg cursor-pointer hover:shadow-lg transition duration-200 border border-gray-200';
                    memoDiv.dataset.id = memoId;
                    memoDiv.innerHTML = `
                        <p class="text-sm text-gray-900 break-words">${escapeHTML(memo.content)}</p>
                    `;
                    
                    memoDiv.addEventListener('click', () => openMemoModal(memoId, memo.content));
                    
                    listElement.appendChild(memoDiv);
                });
            }, (error) => console.error(`Multi-view memo snapshot error for ${categoryName}:`, error));
            
            multiViewUnsubscribers[categoryName] = unsubscribe;
        }
        
        // 멀티뷰 열 개수 업데이트
        function updateMultiViewColumns() {
            if (multiViewContainer) {
                multiViewContainer.className = `grid grid-cols-1 md:grid-cols-${currentMultiCols} gap-6`;
            }
            updateMultiColButtonStyles();
        }
        
        function updateMultiColButtonStyles() {
            multiColButtons.forEach(btn => {
                const cols = parseInt(btn.getAttribute('data-multi-cols'));
                if (cols === currentMultiCols) {
                    btn.classList.add('border-blue-500', 'bg-blue-50');
                    btn.classList.remove('border-gray-300');
                } else {
                    btn.classList.add('border-gray-300');
                    btn.classList.remove('border-blue-500', 'bg-blue-50');
                }
            });
        }

        // --- 리스너 설정 ---
        function setupCategoryListener() {
            if (!isAuthReady || !categoriesCollectionRef) return;

            console.log("Setting up category listener");
            if (unsubscribeCategories) unsubscribeCategories();

            unsubscribeCategories = onSnapshot(categoriesCollectionRef, renderCategories, (error) => {
                console.error("Category snapshot error:", error);
            });
        }

        function setupMemoListeners(categoryName) {
            if (!isAuthReady || !memosCollectionRef) return;

            console.log(`Setting up memo listeners for: ${categoryName}`);
            
            if (unsubscribePendingMemos) unsubscribePendingMemos();

            const pendingQuery = query(
                memosCollectionRef, 
                where("category", "==", categoryName),
                where("completed", "==", false)
            );
            unsubscribePendingMemos = onSnapshot(pendingQuery, (snapshot) => {
                renderMemos(snapshot, memoListPending);
            }, (error) => console.error("Pending memo snapshot error:", error));
        }

        function setupPointsListener() {
             if (!isAuthReady || !pointsDocRef) return;
            onSnapshot(pointsDocRef, renderPoints, (error) => {
                console.error("Points snapshot error:", error);
            });
            getDoc(pointsDocRef).then(renderPoints).catch(error => {
                console.error("Initial points fetch error:", error);
            });
        }
        
        // 포인트 내역 리스너
        function setupPointHistoryListener() {
            if (!isAuthReady || !pointHistoryCollectionRef) return;
            
            if (unsubscribePointHistory) unsubscribePointHistory();
            
            const q = query(pointHistoryCollectionRef, orderBy("timestamp", "desc"));
            unsubscribePointHistory = onSnapshot(q, renderPointHistory, (error) => {
                console.error("Point history snapshot error:", error);
            });
        }

        // --- UI 렌더링 ---
        function renderCategories(snapshot) {
            categoryList.innerHTML = '';
            if (snapshot.empty) {
                categoryList.innerHTML = '<p class="text-gray-500">카테고리를 추가해주세요.</p>';
                return;
            }

            snapshot.docs.forEach(doc => {
                const category = doc.data();
                const categoryName = category.name;

                const card = document.createElement('div');
                card.className = 'p-6 rounded-2xl shadow-md cursor-pointer hover:shadow-lg transition-all duration-200 border bg-white';

                const contentWrap = document.createElement('div');
                contentWrap.className = 'flex-1';
                contentWrap.innerHTML = `
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <h3 class="text-2xl font-extrabold text-gray-800 category-name" data-category-id="${doc.id}">${escapeHTML(categoryName)}</h3>
                            <p class="text-gray-500 text-base mt-2 pending-count font-bold">계산 중...</p>
                        </div>
                        ${isMultiViewMode ? 
                            `<input type=\"checkbox\" class=\"category-checkbox w-6 h-6 mt-1\" data-category=\"${escapeHTML(categoryName)}\">` : 
                            `<button class=\"delete-category-btn w-9 h-9 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center text-red-500 text-xl font-bold shadow transition-all duration-150\" data-category-id=\"${doc.id}\" data-category-name=\"${escapeHTML(categoryName)}\">×</button>`
                        }
                    </div>`;
                card.appendChild(contentWrap);

                updatePendingCount(card, categoryName);

                const categoryNameElement = card.querySelector('.category-name');

                if (!isMultiViewMode) {
                    // 일반 클릭: 상세 페이지로 이동
                    card.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('category-name') && !e.target.classList.contains('delete-category-btn')) {
                            showDetailPage(categoryName);
                        }
                    });
                    
                    // 카테고리 이름 더블클릭: 수정 모드
                    categoryNameElement.addEventListener('dblclick', (e) => {
                        e.stopPropagation();
                        editCategoryName(categoryNameElement, doc.id, categoryName);
                    });
                    
                    // 삭제 버튼 클릭
                    const deleteBtn = card.querySelector('.delete-category-btn');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteCategory(doc.id, categoryName);
                        });
                    }
                } else {
                    const checkbox = card.querySelector('.category-checkbox');
                    checkbox.addEventListener('change', (e) => {
                        if (e.target.checked) {
                            selectedCategories.push(categoryName);
                        } else {
                            selectedCategories = selectedCategories.filter(c => c !== categoryName);
                        }
                    });
                }

                categoryList.appendChild(card);
            });
        }

        async function updatePendingCount(cardElement, categoryName) {
            if (!memosCollectionRef) return;
            try {
                const q = query(memosCollectionRef, 
                    where("category", "==", categoryName), 
                    where("completed", "==", false)
                );
                const snapshot = await getDocs(q);
                const count = snapshot.size;
                
                const countElement = cardElement.querySelector('.pending-count');
                if (countElement) {
                    countElement.textContent = `${count}개 진행 중`;
                }
            } catch (error) {
                console.error(`Error fetching count for ${categoryName}:`, error);
                const countElement = cardElement.querySelector('.pending-count');
                if (countElement) {
                    countElement.textContent = `개수 로드 실패`;
                }
            }
        }

        function renderMemos(snapshot, listElement) {
            listElement.innerHTML = '';
            
            // 비어 있어도 메시지를 표시하지 않음
            if (snapshot.empty) return;
            
            snapshot.docs.forEach(doc => {
                const memo = doc.data();
                const memoId = doc.id;

                const iconColor = 'text-gray-400';
                const textStyle = 'text-gray-900';
                
                const memoDiv = document.createElement('div');
                memoDiv.className = 'p-4 rounded-2xl shadow-md cursor-pointer hover:shadow-lg transition-all duration-200 border bg-white';
                memoDiv.dataset.id = memoId;

                memoDiv.innerHTML = `<p class="${textStyle} break-words whitespace-pre-wrap text-base font-semibold">${escapeHTML(memo.content)}</p>`;

                memoDiv.addEventListener('click', () => openMemoModal(memoId, memo.content));
                
                listElement.appendChild(memoDiv);
            });
        }

        function renderPoints(docSnap) {
            currentPoints = (docSnap && docSnap.exists()) ? docSnap.data().value || 0 : 0;
            pointsDisplay.textContent = `${currentPoints} P`;
            if (totalPointsDisplay) {
                totalPointsDisplay.textContent = `${currentPoints} P`;
            }
        }
        
        // 포인트 내역 렌더링
        function renderPointHistory(snapshot) {
            pointHistoryList.innerHTML = '';
            
            if (snapshot.empty) {
                pointHistoryList.innerHTML = '<p class="text-purple-500 text-center py-8 text-2xl font-bold">🎈 아직 모은 포인트가 없어요!</p>';
                return;
            }
            
            const history = [];
            snapshot.docs.forEach(doc => {
                history.push({ id: doc.id, ...doc.data() });
            });
            
            // 최신순 정렬
            history.sort((a, b) => {
                if (a.timestamp && b.timestamp) {
                    return b.timestamp.toMillis() - a.timestamp.toMillis();
                }
                return 0;
            });
            
            history.forEach(item => {
                const div = document.createElement('div');
                const bgGradient = item.points >= 1000 
                    ? 'bg-gradient-to-r from-yellow-200 to-orange-200' 
                    : 'bg-gradient-to-r from-green-200 to-blue-200';
                div.className = `${bgGradient} rounded-3xl p-6 shadow-lg flex justify-between items-center border-4 border-white transform hover:scale-105 transition-all duration-300`;
                
                const date = item.timestamp ? item.timestamp.toDate().toLocaleString('ko-KR') : '날짜 없음';
                const pointsClass = item.points >= 1000 ? 'text-yellow-600 text-3xl' : 'text-green-600 text-2xl';
                const icon = item.points >= 1000 ? '🏆' : '⭐';
                
                div.innerHTML = `
                    <div>
                        <p class="font-bold text-gray-900 text-xl">${escapeHTML(item.description || '메모 완료')}</p>
                        <p class="text-base text-gray-700 font-semibold mt-1">${date}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-4xl mr-2">${icon}</span>
                        <span class="${pointsClass} font-bold">+${item.points} P</span>
                    </div>
                `;
                
                pointHistoryList.appendChild(div);
            });
        }

        function showToast() {
            // 토스트 메시지 제거됨
        }
        
        // 텍스트를 음성으로 재생하는 함수
        function speakText(text) {
            if ('speechSynthesis' in window) {
                // 기존 음성이 재생 중이면 중지
                window.speechSynthesis.cancel();
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ko-KR'; // 한국어 설정
                utterance.rate = 1.0; // 속도 (0.1 ~ 10)
                utterance.pitch = 1.2; // 음높이 (0 ~ 2, 높을수록 여성스러움)
                utterance.volume = 1.0; // 볼륨 (0 ~ 1)
                
                // 한국어 여성 목소리 찾기
                const voices = window.speechSynthesis.getVoices();
                const koreanFemaleVoice = voices.find(voice => 
                    voice.lang.includes('ko') && voice.name.includes('Female')
                ) || voices.find(voice => 
                    voice.lang.includes('ko')
                );
                
                if (koreanFemaleVoice) {
                    utterance.voice = koreanFemaleVoice;
                }
                
                window.speechSynthesis.speak(utterance);
            }
        }
        
        // 음성 목록 로드 (페이지 로드 시)
        if ('speechSynthesis' in window) {
            // 일부 브라우저에서는 음성 목록이 비동기로 로드됨
            window.speechSynthesis.onvoiceschanged = () => {
                window.speechSynthesis.getVoices();
            };
        }

        // --- 모달 함수 ---
        function openMemoModal(memoId, content) {
            modalMemoId.value = memoId;
            modalMemoText.value = content;
            memoModal.classList.remove('hidden');
            setTimeout(() => {
                memoModal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10);
        }

        function hideMemoModal() {
            memoModal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            setTimeout(() => {
                memoModal.classList.add('hidden');
            }, 300);
        }

        // --- 이벤트 핸들러 ---
        
        // 카테고리 이름 수정
        function editCategoryName(nameElement, categoryId, currentName) {
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'text-2xl font-bold text-gray-800 bg-white border-2 border-blue-500 rounded px-2 py-1 w-full';
            
            nameElement.replaceWith(input);
            input.focus();
            input.select();
            
            async function saveName() {
                const newName = input.value.trim();
                if (newName === '' || newName === currentName) {
                    const h3 = document.createElement('h3');
                    h3.className = 'text-2xl font-bold text-gray-800 category-name';
                    h3.dataset.categoryId = categoryId;
                    h3.textContent = currentName;
                    input.replaceWith(h3);
                    
                    h3.addEventListener('dblclick', (e) => {
                        e.stopPropagation();
                        editCategoryName(h3, categoryId, currentName);
                    });
                    return;
                }
                
                try {
                    const categoryRef = doc(db, 'users', userId, 'categories', categoryId);
                    await updateDoc(categoryRef, { name: newName });
                } catch (error) {
                    console.error("Error updating category name: ", error);
                    alert('카테고리 이름 변경 실패');
                }
            }
            
            input.addEventListener('blur', saveName);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    input.blur();
                } else if (e.key === 'Escape') {
                    const h3 = document.createElement('h3');
                    h3.className = 'text-2xl font-bold text-gray-800 category-name';
                    h3.dataset.categoryId = categoryId;
                    h3.textContent = currentName;
                    input.replaceWith(h3);
                    
                    h3.addEventListener('dblclick', (e) => {
                        e.stopPropagation();
                        editCategoryName(h3, categoryId, currentName);
                    });
                }
            });
        }
        
        async function handleAddCategory(event) {
            event.preventDefault();
            if (!isAuthReady) return;
            const name = categoryNameInput.value.trim();
            if (name === '') return;

            try {
                await addDoc(categoriesCollectionRef, { name: name });
                categoryNameInput.value = '';
            } catch (error) {
                console.error("Error adding category: ", error);
            }
        }
        
        // 카테고리 삭제
        async function deleteCategory(categoryId, categoryName) {
            if (!confirm(`"${categoryName}" 카테고리를 삭제하시겠습니까?\n관련된 모든 메모도 함께 삭제됩니다.`)) {
                return;
            }
            
            try {
                // 해당 카테고리의 모든 메모 삭제
                const memosQuery = query(memosCollectionRef, where("category", "==", categoryName));
                const memosSnapshot = await getDocs(memosQuery);
                
                const deletePromises = [];
                memosSnapshot.docs.forEach(memoDoc => {
                    deletePromises.push(deleteDoc(doc(db, 'users', userId, 'memos', memoDoc.id)));
                });
                
                // 카테고리 삭제
                deletePromises.push(deleteDoc(doc(db, 'users', userId, 'categories', categoryId)));
                
                await Promise.all(deletePromises);
                
                console.log(`Category "${categoryName}" and its memos deleted successfully`);
            } catch (error) {
                console.error("Error deleting category: ", error);
                alert('카테고리 삭제 실패');
            }
        }

        async function handleAddMemo(event) {
            event.preventDefault();
            if (!isAuthReady || !currentCategory) return;
            const content = memoContentInput.value.trim();
            if (content === '') return;

            try {
                await addDoc(memosCollectionRef, { 
                    content: content,
                    category: currentCategory,
                    completed: false,
                    createdAt: Timestamp.now()
                });
                memoContentInput.value = '';
            } catch (error) {
                console.error("Error adding memo: ", error);
            }
        }

        // 메모 수정
        async function handleUpdateMemo() {
            const docId = modalMemoId.value;
            const newContent = modalMemoText.value.trim();
            if (!isAuthReady || !docId || newContent === '') return;

            const docRef = doc(db, 'users', userId, 'memos', docId);
            try {
                await updateDoc(docRef, {
                    content: newContent
                });
                hideMemoModal();
            } catch (error) {
                console.error("Error updating memo: ", error);
            }
        }

        // 메모 삭제 (포인트 없음)
        async function handleDeleteMemo() {
            const docId = modalMemoId.value;
            if (!isAuthReady || !docId) return;

            if (!confirm('정말 삭제하시겠습니까?')) return;

            const docRef = doc(db, 'users', userId, 'memos', docId);
            try {
                await deleteDoc(docRef);
                hideMemoModal();
                showToast(); // "잘했어요!" 메시지 표시
            } catch (error) {
                console.error("Error deleting memo: ", error);
            }
        }

        // 메모 완료 (포인트 적립 + 애니메이션 + 삭제)
        async function completeAndRemoveMemo() {
            const docId = modalMemoId.value;
            if (!isAuthReady || !docId) return;

            try {
                // 메모 정보 가져오기
                const memoRef = doc(db, 'users', userId, 'memos', docId);
                const memoSnap = await getDoc(memoRef);
                const memoData = memoSnap.data();
                const memoCategory = memoData.category;
                
                // 포인트 적립
                const newPoints = currentPoints + 500;
                await setDoc(pointsDocRef, { value: newPoints });
                
                // 포인트 내역 추가
                await addDoc(pointHistoryCollectionRef, {
                    points: 500,
                    description: `${memoCategory} - 메모 완료`,
                    timestamp: Timestamp.now()
                });
                
                // 모달 닫기
                hideMemoModal();
                
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // 메모 카드 애니메이션
                await animateMemoDelete(docId);
                
                // DB에서 메모 삭제
                await deleteDoc(memoRef);
                
            } catch (error) {
                console.error("Error completing and removing memo: ", error);
            }
        }
        
        // 메모 카드 삭제 애니메이션
        async function animateMemoDelete(memoId) {
            console.log('🎯 메모 삭제 애니메이션 시작:', memoId);
            
            try {
                // 메모 카드 찾기
                const memoCard = document.querySelector(`[data-id="${memoId}"]`);
                
                if (!memoCard) {
                    console.error('❌ 메모 카드를 찾을 수 없음');
                    return;
                }
                
                console.log('✅ 메모 카드 찾음');
                
                const cardRect = memoCard.getBoundingClientRect();
                console.log('📦 메모 카드 위치:', cardRect);
                
                // 캐릭터 생성 - 화면 중앙
                const character = document.createElement('div');
                character.style.position = 'fixed';
                character.style.zIndex = '9999';
                character.style.pointerEvents = 'none';
                character.style.left = '50%';
                character.style.top = '50%';
                character.style.transform = 'translate(-50%, -50%)';
                character.style.opacity = '0';
                character.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                
                const charImg = document.createElement('img');
                charImg.src = 'character.png';
                charImg.style.width = '150px';
                charImg.style.height = 'auto';
                charImg.style.transform = 'scaleX(-1)';
                charImg.onerror = () => {
                    character.innerHTML = '<div style="font-size:100px">🔨</div>';
                };
                character.appendChild(charImg);
                
                document.body.appendChild(character);
                console.log('👤 캐릭터 생성');
                
                // 등장
                setTimeout(() => character.style.opacity = '1', 50);
                
                await new Promise(resolve => setTimeout(resolve, 400));
                
                // 망치 스윙 준비
                character.style.transform = 'translate(-50%, -50%) rotate(-25deg)';
                console.log('🔄 스윙 준비');
                
                await new Promise(resolve => setTimeout(resolve, 150));
                
                // 망치 스윙!
                character.style.transform = 'translate(-50%, -50%) rotate(10deg)';
                console.log('💥 스윙!');
                
                await new Promise(resolve => setTimeout(resolve, 120));
                
                // 폭죽! (화면 중앙 상단에서)
                console.log('🎆 폭죽 발사');
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 3;
                createFireworks(centerX, centerY);
                playFireworkSound();
                
                // 메모 카드 타격
                memoCard.style.transition = 'all 0.25s ease';
                memoCard.style.transform = 'scale(0.85) rotate(5deg)';
                
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // 메모 카드 날아가며 사라짐
                memoCard.style.transition = 'all 0.4s ease';
                memoCard.style.transform = 'scale(0) rotate(45deg) translateX(100px)';
                memoCard.style.opacity = '0';
                console.log('💨 메모 카드 날아감');
                
                await new Promise(resolve => setTimeout(resolve, 400));
                
                // 캐릭터 퇴장 (제자리에서 페이드 아웃)
                character.style.opacity = '0';
                console.log('👋 캐릭터 퇴장');
                
                await new Promise(resolve => setTimeout(resolve, 500));
                character.remove();
                
            } catch (error) {
                console.error('❌ 메모 애니메이션 에러:', error);
            }
        }
        
        // 카테고리 완료 체크 - 더 이상 사용 안 함
        async function checkCategoryCompletion(categoryName) {
            // 카테고리는 삭제하지 않음
        }
        
        // 캐릭터 망치 애니메이션 + 폭죽 + 카테고리 삭제
        async function showAchievementMessage(categoryName) {
            console.log('🎯 애니메이션 시작:', categoryName);
            
            try {
                // 먼저 카테고리 ID 찾기 (삭제 전)
                let categoryIdToDelete = null;
                const cardsSnapshot = await getDocs(categoriesCollectionRef);
                cardsSnapshot.docs.forEach(d => {
                    if (d.data().name === categoryName) {
                        categoryIdToDelete = d.id;
                    }
                });
                
                console.log('📍 카테고리 ID:', categoryIdToDelㅁete);
                
                // 홈으로 돌아가기
                showHomePage();
                
                await new Promise(resolve => setTimeout(resolve, 600));
                
                // 해당 카테고리 카드 찾기
                const cards = Array.from(categoryList.children);
                const targetCard = cards.find(card => {
                    const nameEl = card.querySelector('.category-name');
                    return nameEl && nameEl.textContent === categoryName;
                });
                
                if (!targetCard) {
                    console.error('❌ 카드를 찾을 수 없음');
                    return;
                }
                
                console.log('✅ 카드 찾음');
                
                const cardRect = targetCard.getBoundingClientRect();
                console.log('📦 카드 위치:', cardRect);
                
                // 캐릭터 생성 (이미지 로드 대기 없이 바로 진행)
                const character = document.createElement('div');
                character.style.position = 'fixed';
                character.style.zIndex = '9999';
                character.style.pointerEvents = 'none';
                character.style.left = (cardRect.left - 200) + 'px';
                character.style.top = (cardRect.top - 50) + 'px';
                character.style.opacity = '0';
                character.style.transition = 'opacity 0.3s ease, left 0.5s ease, transform 0.3s ease';
                const charImg = document.createElement('img');
                charImg.src = 'character.png';
                charImg.style.width = '180px';
                charImg.style.height = 'auto';
                charImg.style.transform = 'scaleX(-1)';
                charImg.onerror = () => {
                    character.innerHTML = '<div style="font-size:120px">🔨</div>';
                };
                character.appendChild(charImg);
                
                document.body.appendChild(character);
                console.log('👤 캐릭터 생성');
                
                // 등장
                setTimeout(() => character.style.opacity = '1', 50);
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 망치 스윙 준비
                character.style.transform = 'rotate(-30deg)';
                console.log('🔄 스윙 준비');
                
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // 망치 스윙!
                character.style.transform = 'rotate(15deg)';
                console.log('💥 스윙!');
                
                await new Promise(resolve => setTimeout(resolve, 150));
                
                // 폭죽 먼저!
                console.log('🎆 폭죽 발사');
                createFireworks(cardRect.left + cardRect.width/2, cardRect.top + cardRect.height/2);
                
                // 카드 타격
                targetCard.style.transition = 'all 0.3s ease';
                targetCard.style.transform = 'scale(0.85) rotate(5deg)';
                
                await new Promise(resolve => setTimeout(resolve, 400));
                
                // 카드 날아가며 사라짐
                targetCard.style.transition = 'all 0.5s ease';
                targetCard.style.transform = 'scale(0) rotate(90deg) translateY(-150px)';
                targetCard.style.opacity = '0';
                console.log('💨 카드 날아감');
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 캐릭터 퇴장
                character.style.left = (cardRect.left - 400) + 'px';
                character.style.opacity = '0';
                console.log('👋 캐릭터 퇴장');
                
                await new Promise(resolve => setTimeout(resolve, 600));
                character.remove();
                
                // 이제 DB에서 카테고리 삭제
                if (categoryIdToDelete) {
                    const categoryRef = doc(db, 'users', userId, 'categories', categoryIdToDelete);
                    await deleteDoc(categoryRef);
                    console.log('🗑️ DB에서 삭제 완료');
                }
            } catch (error) {
                console.error('❌ 애니메이션 에러:', error);
            }
        }
        
        // 폭죽 효과 - 위로 올라가며 터짐
        function createFireworks(x, y) {
            const colors = ['#ff6b6b', '#4ecdc4', '#ffe66d', '#a8e6cf', '#ff8787', '#ffa07a', '#98d8c8'];
            
            // 3개의 폭죽을 순차적으로 발사
            for (let wave = 0; wave < 3; wave++) {
                setTimeout(() => {
                    for (let i = 0; i < 40; i++) {
                        const particle = document.createElement('div');
                        particle.style.position = 'fixed';
                        particle.style.left = x + 'px';
                        particle.style.top = y + 'px';
                        particle.style.width = '10px';
                        particle.style.height = '10px';
                        particle.style.borderRadius = '50%';
                        particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                        particle.style.pointerEvents = 'none';
                        particle.style.zIndex = '9998';
                        particle.style.boxShadow = '0 0 4px ' + colors[Math.floor(Math.random() * colors.length)];
                        
                        const angle = (Math.PI * 2 * i) / 40;
                        const velocity = 150 + Math.random() * 150;
                        const vx = Math.cos(angle) * velocity;
                        const vy = Math.sin(angle) * velocity - 100; // 위로 더 강하게
                        
                        document.body.appendChild(particle);
                        
                        let px = x, py = y;
                        let frame = 0;
                        const animate = () => {
                            frame++;
                            px += vx * 0.016;
                            py += vy * 0.016 + frame * 0.8; // 중력
                            particle.style.left = px + 'px';
                            particle.style.top = py + 'px';
                            particle.style.opacity = Math.max(0, 1 - frame / 70);
                            particle.style.transform = `scale(${1 - frame / 70})`;
                            
                            if (frame < 70) requestAnimationFrame(animate);
                            else particle.remove();
                        };
                        animate();
                    }
                }, wave * 150);
            }
        }
        
        // 폭죽 소리 재생 - 진짜 폭죽 "펑파팡!"
        function playFireworkSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                // 3번의 폭죽 폭발음
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        // 큰 폭발음을 위한 화이트 노이즈
                        const bufferSize = audioContext.sampleRate * 0.5;
                        const buffer = audioContext.createBuffer(2, bufferSize, audioContext.sampleRate);
                        
                        for (let channel = 0; channel < 2; channel++) {
                            const data = buffer.getChannelData(channel);
                            for (let i = 0; i < bufferSize; i++) {
                                data[i] = Math.random() * 2 - 1;
                            }
                        }
                        
                        const noise = audioContext.createBufferSource();
                        noise.buffer = buffer;
                        
                        // 로우패스 필터로 둔탁한 폭발음
                        const filter = audioContext.createBiquadFilter();
                        filter.type = 'lowpass';
                        filter.frequency.setValueAtTime(300, audioContext.currentTime);
                        filter.frequency.exponentialRampToValueAtTime(100, audioContext.currentTime + 0.3);
                        filter.Q.value = 0.5;
                        
                        const gain = audioContext.createGain();
                        
                        noise.connect(filter);
                        filter.connect(gain);
                        gain.connect(audioContext.destination);
                        
                        // 급격하게 커졌다가 서서히 사라지는 폭발음
                        gain.gain.setValueAtTime(0, audioContext.currentTime);
                        gain.gain.linearRampToValueAtTime(0.8, audioContext.currentTime + 0.01);
                        gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                        
                        noise.start(audioContext.currentTime);
                        noise.stop(audioContext.currentTime + 0.5);
                        
                        // 폭발의 "우웅~" 하는 저음
                        const bass = audioContext.createOscillator();
                        const bassGain = audioContext.createGain();
                        bass.connect(bassGain);
                        bassGain.connect(audioContext.destination);
                        
                        bass.type = 'sine';
                        bass.frequency.setValueAtTime(80, audioContext.currentTime);
                        bass.frequency.exponentialRampToValueAtTime(20, audioContext.currentTime + 0.3);
                        
                        bassGain.gain.setValueAtTime(0, audioContext.currentTime);
                        bassGain.gain.linearRampToValueAtTime(0.4, audioContext.currentTime + 0.02);
                        bassGain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
                        
                        bass.start(audioContext.currentTime);
                        bass.stop(audioContext.currentTime + 0.4);
                        
                    }, i * 250);
                }
            } catch (error) {
                console.log('오디오 재생 불가:', error);
            }
        }
        
        function hideAchievementMessage() {
            achievementMessage.classList.add('opacity-0');
            achievementMessage.querySelector('div').classList.remove('scale-100');
            achievementMessage.querySelector('div').classList.add('scale-95');
            setTimeout(() => {
                achievementMessage.classList.add('hidden');
            }, 300);
        }
        
        // 포인트 초기화
        async function resetPoints() {
            if (!confirm('정말로 모든 포인트와 적립 내역을 초기화하시겠습니까?\n이 작업은 되돌릴 수 없습니다.')) {
                return;
            }
            
            try {
                // 포인트를 0으로 설정
                await setDoc(pointsDocRef, { value: 0 });
                
                // 모든 포인트 내역 삭제
                const historySnapshot = await getDocs(pointHistoryCollectionRef);
                const deletePromises = [];
                historySnapshot.docs.forEach(historyDoc => {
                    deletePromises.push(deleteDoc(doc(db, 'users', userId, 'pointHistory', historyDoc.id)));
                });
                
                await Promise.all(deletePromises);
                
                alert('포인트가 초기화되었습니다.');
            } catch (error) {
                console.error("Error resetting points: ", error);
                alert('포인트 초기화 실패');
            }
        }

        // --- 유틸리티 ---
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function(m) {
                return {'&': '&amp;','<': '&lt;','>': '&gt;','"': '&quot;',"'": '&#39;'}[m];
            });
        }

        // --- 앱 시작 ---
        if (categoryForm) categoryForm.addEventListener('submit', handleAddCategory);
        if (memoForm) memoForm.addEventListener('submit', handleAddMemo);
        if (backToHomeBtn) backToHomeBtn.addEventListener('click', showHomePage);
        if (backToHomeMultiBtn) backToHomeMultiBtn.addEventListener('click', showHomePage);
        if (backToHomePointsBtn) backToHomePointsBtn.addEventListener('click', showHomePage);
        if (pointHistoryBtn) pointHistoryBtn.addEventListener('click', showPointHistoryPage);
        if (pointsBox) pointsBox.addEventListener('click', showPointHistoryPage);
        if (resetPointsBtn) resetPointsBtn.addEventListener('click', resetPoints);
        if (achievementCloseBtn) achievementCloseBtn.addEventListener('click', hideAchievementMessage);
        
        // 멀티뷰 버튼 클릭
        if (multiViewBtn) multiViewBtn.addEventListener('click', () => {
            if (!isMultiViewMode) {
                isMultiViewMode = true;
                selectedCategories = [];
                multiViewBtn.textContent = '선택 완료';
                multiViewBtn.classList.remove('bg-white', 'hover:bg-gray-50', 'text-gray-900');
                multiViewBtn.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white');
                setupCategoryListener(); // 다시 렌더링
            } else {
                showMultiViewPage();
            }
        });
        
        // 멀티뷰 열 개수 버튼
        multiColButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                currentMultiCols = parseInt(btn.getAttribute('data-multi-cols'));
                updateMultiViewColumns();
            });
        });

        // 모달 버튼 리스너
        modalSaveBtn.addEventListener('click', handleUpdateMemo); // 수정
        modalDeleteBtn.addEventListener('click', handleDeleteMemo); // 삭제
        modalCompleteBtn.addEventListener('click', completeAndRemoveMemo); // 완료
        modalCancelBtn.addEventListener('click', hideMemoModal); // 취소
        
        // 모달 바깥 영역 클릭 시 닫기
        memoModal.addEventListener('click', (e) => {
            if (e.target === memoModal) {
                hideMemoModal();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            setHeaderColor();
            initFirebase();
        });

    </script>
</body>
</html>
